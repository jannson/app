cscope 15 /opt/projects/source/pys/pypress-tornado -q 0000001209 0000090194
	@manager.py

1 #!/
u¤
/
bš
/
’v
 
pythÚ


2 #codšg=
utf
-8

4 
impÜt
 
uuid


6 
impÜt
 
	gtÜÇdo
.
h‰p£rv”


7 
impÜt
 
	gtÜÇdo
.
iŞoİ


8 
impÜt
 
	gtÜÇdo
.
İtiÚs


10 
äom
 
	gtÜÇdo
.
İtiÚs
 
impÜt
 
	gdefše
, options

12 
äom
 
py´ess
 
impÜt
 
AµliÿtiÚ


13 
äom
 
	gpy´ess
.
mod–s
 
impÜt
 *

14 
äom
 
	gpy´ess
.
d©aba£
 
impÜt
 
db


16 
defše
("cmd", ='runserver',

17 
m‘av¬
="runserver|createall|dropall|createcode",

18 
h–p
=("Default use„unserver"))

19 
defše
("pÜt", =9000, 
h–p
="deçuÉ: 9000,„equœed„un£rv”", 
ty³
=)

20 
defše
("num", =1, 
h–p
="numb” oàü—‹ codes.„equœed c»©ecode", 
ty³
=)

21 
defše
("rŞe", ='admš', 
m‘av¬
="admš|mod”©Ü|memb”", 
h–p
="required createcode")

23 
def
 
	$maš
():

24 
tÜÇdo
.
İtiÚs
.
	$·r£_commªd_lše
()

26 
İtiÚs
.
cmd
 == 'runserver':

27 
´št
 '£rv” s¹ed.…Üˆ%s' % 
İtiÚs
.
pÜt


28 
h‰p_£rv”
 = 
tÜÇdo
.
h‰p£rv”
.
	`HTTPS”v”
(
	$AµliÿtiÚ
())

29 
h‰p_£rv”
.
	$li¡’
(
İtiÚs
.
pÜt
)

30 
tÜÇdo
.
iŞoİ
.
IOLoİ
.
	`š¡ªû
().
	$¡¬t
()

32 
–if
 
İtiÚs
.
cmd
 == 'createall':

34 
db
.
	$ü—‹_®l
()

35 
´št
 'create‡ll [ok]'

37 
–if
 
İtiÚs
.
cmd
 == 'dropall':

39 
db
.
	$drİ_®l
()

40 
´št
 'drop‡ll [ok]'

42 
–if
 
İtiÚs
.
cmd
 == 'createcode':

43 
codes
 = []

44 
u£rcodes
 = []

45 
i
 
š
 
	$¿nge
(
İtiÚs
.
num
):

46 
code
 = 
	`unicode
(
uuid
.
	`uuid4
()).
	`¥l™
('-')[0]

47 
codes
.
	$­³nd
(
code
)

48 
u£rcode
 = 
	$U£rCode
()

49 
u£rcode
.
code
 = code

50 
İtiÚs
.
rŞe
 == "admin":

51 
u£rcode
.
rŞe
 = 
U£r
.
ADMIN


52 
–if
 
İtiÚs
.
rŞe
 == "moderator":

53 
u£rcode
.
rŞe
 = 
U£r
.
MODERATOR


55 
u£rcode
.
rŞe
 = 
U£r
.
MEMBER


56 
u£rcodes
.
	$­³nd
(
u£rcode
)

57 
İtiÚs
.
num
==1:

58 
db
.
£ssiÚ
.
	$add
(
u£rcode
)

60 
db
.
£ssiÚ
.
	$add_®l
(
u£rcodes
)

61 
db
.
£ssiÚ
.
	$comm™
()

62 
´št
 "Sign up code:"

63 
i
 
š
 
codes
:

64 
´št
 
i


67 
´št
 'error cmd…aram:…ython manager.py --help'

69 
__Çme__
=='__main__':

70 
	`maš
()

	@pypress/__init__.py

1 #!/
u¤
/
bš
/
’v
 
pythÚ


2 #codšg=
utf
-8

4 
py´ess
 
	gAµliÿtiÚ


6 :
authÜ
: 
Ïoqiu
.
com
@
gma
.com

8 
impÜt
 
os


9 
impÜt
 
»dis


11 
impÜt
 
tÜÇdo
.
web


12 
impÜt
 
tÜÇdo
.
loÿË


14 
äom
 
tÜÇdo
.
web
 
impÜt
 
u¾


16 
äom
 
py´ess
 
impÜt
 
£‰šgs
 
as
 
cÚfig


17 
äom
 
py´ess
 
impÜt
 
uimoduËs


18 
äom
 
py´ess
.
h–³rs
 
impÜt
 
£‰šg_äom_objeù


19 
äom
 
py´ess
.
fÜms
 
impÜt
 
ü—‹_fÜms


20 
äom
 
py´ess
.
v›ws
 
impÜt
 
accouÁ
, 
	gblog
, 
	glšks
, 
E¼ÜHªdËr


21 
äom
 
	gpy´ess
.
d©aba£
 
impÜt
 
	gdb
, 
mod–s_comm™‹d


22 
äom
 
	gpy´ess
.
	gex‹nsiÚs
.
routšg
 
impÜt
 
Rou‹


23 
äom
 
	gpy´ess
.
	gex‹nsiÚs
.
£ssiÚs
 
impÜt
 
RedisSessiÚStÜe


25 
şass
 
	$AµliÿtiÚ
(
tÜÇdo
.
web
.
AµliÿtiÚ
):

26 
def
 
	$__š™__
(
£lf
):

27 
£‰šgs
 = 
	$£‰šg_äom_objeù
(
cÚfig
)

28 
hªdËrs
 = [

29 #Ùh” 
hªdËrs
...

30 
	`u¾
(
r
"/theme/¡©ic/(.+)", 
tÜÇdo
.
web
.
SticFeHªdËr
, 
	`diù
(
·th
=
£‰šgs
['theme_¡©ic_·th']), 
Çme
='theme_static'),

31 
	`u¾
(
r
"/u¶ßd/(.+)", 
tÜÇdo
.
web
.
SticFeHªdËr
, 
	`diù
(
·th
=
£‰šgs
['u¶ßd_·th']), 
Çme
='upload_path')

32 ] + 
Rou‹
.
	$rou‹s
()

34 #Cu¡om 404 
E¼ÜHªdËr


35 
hªdËrs
.
	`­³nd
((
r
"/(.*)", 
E¼ÜHªdËr
))

37 
£‰šgs
.
	`upd©e
(
	$diù
(

38 
ui_moduËs
 = 
uimoduËs
,

39 
autÛsÿ³
 = 
NÚe


42 'deçuÉ_loÿË' 
š
 
£‰šgs
:

43 
tÜÇdo
.
loÿË
.
	`lßd_g‘‹xt_Œª¦©iÚs
(

44 
os
.
·th
.
	`još
(os.·th.
	`dœÇme
(
__fe__
), 'translations'), 'messages')

46 
tÜÇdo
.
web
.
AµliÿtiÚ
.
	$__š™__
(
£lf
, 
hªdËrs
, **
£‰šgs
)

48 
£lf
.
fÜms
 = 
	$ü—‹_fÜms
()

49 
poŞ
 = 
»dis
.
	`CÚÃùiÚPoŞ
(
ho¡
=
£‰šgs
['»dis_ho¡'], 
pÜt
=£‰šgs['»dis_pÜt'], 
db
=settings['redis_db'])

50 
£lf
.
»dis
 =„edis.
	$Redis
(
cÚÃùiÚ_poŞ
=
poŞ
)

51 
£lf
.
£ssiÚ_¡Üe
 = 
	$RedisSessiÚStÜe
(
£lf
.
»dis
)

53 
	$cÚfigu»_sigÇls
(
db
.
£nd”
)

56 
def
 
	$cÚfigu»_sigÇls
(
£nd”
):

58 @
mod–s_comm™‹d
.
	$cÚÃù_vŸ
(
£nd”
)

59 
def
 
	$Ú_mod–s_comm™ed
(
£nd”
, 
chªges
):

60 #´šˆ
£nd”


61 
·ss


	@pypress/database.py

1 #!/
u¤
/
bš
/
’v
 
pythÚ


2 #codšg=
utf
-8

3 
impÜt
 
£‰šgs


5 
äom
 
	gex‹nsiÚs
.
sqÏlchemy
 
impÜt
 
	gSQLAlchemy
, 
	gBa£Qu”y
, \

6 
	gmod–s_comm™‹d
, 
befÜe_mod–s_comm™‹d


8 
	gdb
 = 
SQLAlchemy
(
£‰šgs
.
SQLALCHEMY_DATABASE_URI
, s‘tšgs.
SQLALCHEMY_DATABASE_ECHO
)

	@pypress/extensions/__init__.py

1 #!/
u¤
/
bš
/
’v
 
pythÚ


	@pypress/extensions/cache.py

1 #!/
u¤
/
bš
/
’v
 
pythÚ


2 #codšg=
utf
-8

4 
	gex‹nsiÚs
.
ÿche


6 
	gExam¶e
:

7 >>> 
äom
 
ex‹nsiÚs
.
ÿche
 
impÜt
 
Sim¶eCache


8 >>> 
c
 = 
Sim¶eCahû
()

9 >>> 
c
.
£t
('a', 'xx')

10 >>> 
	gc
.
g‘
('a')

12 >>> 
	gc
.
g‘
('b'è
is
 
NÚe


13 
	gTrue


15 
impÜt
 
hashlib


16 
äom
 
time
 
impÜt
ime

17 
äom
 
™”toŞs
 
impÜt
 
iz


18 
äom
 
funùoŞs
 
impÜt
 
w¿ps


19 
	gŒy
:

20 
impÜt
 
cPickË
 
as
 
pickË


21 
exû±
 
ImpÜtE¼Ü
:

22 
impÜt
 
pickË


25 
şass
 
	$Ba£Cache
(
objeù
):

26 
def
 
	$__š™__
(
£lf
, 
timeout
=300):

27 
£lf
.
timeout
 =imeout

29 
def
 
	$g‘
(
£lf
, 
key
):

30  
NÚe


32 
def
 
	$g‘_mªy
(
£lf
, *
keys
):

33  
	$m­
(
£lf
.
g‘
, 
keys
)

35 
def
 
	$g‘_diù
(
£lf
, *
keys
):

36  
	`diù
(
	`iz
(
keys
, 
£lf
.
	$g‘_mªy
(*
keys
)))

38 
def
 
	$£t
(
£lf
, 
key
, 
v®ue
, 
timeout
=
NÚe
):

39 
·ss


41 
def
 
	$d–‘e
(
£lf
, 
key
):

42 
·ss


44 
def
 
	$ş—r
(
£lf
):

45 
·ss


47 
def
 
	$m¬k_key
(
£lf
, 
funùiÚ
, 
¬gs
, 
kw¬gs
):

48 
Œy
:

49 
key
 = 
pickË
.
	`dumps
((
funùiÚ
.
func_Çme
, 
¬gs
, 
kw¬gs
))

50 
exû±
:

51 
key
 = 
pickË
.
	$dumps
(
funùiÚ
.
func_Çme
)

52  
hashlib
.
	`sha1
(
key
).
	$hexdige¡
()

54 
def
 
	$ÿched
(
£lf
, 
timeout
=
NÚe
, 
uÆess
=None):

56 
Exam¶e
:

58 
def
 
	$decÜ©Ü
(
f
):

59 @
	$w¿ps
(
f
)

60 
def
 
	$decÜ©ed_funùiÚ
(*
¬gs
, **
kw¬gs
):

61 
	$ÿÎabË
(
uÆess
è
ªd
 
	$uÆess
(è
is
 
True
:

62  
	$f
(*
¬gs
, **
kw¬gs
)

64 
key
 = 
£lf
.
	$m¬k_key
(
f
, 
¬gs
, 
kw¬gs
)

66 
rv
 = 
£lf
.
	$g‘
(
key
)

68 
rv
 
is
 
NÚe
:

69 
rv
 = 
	$f
(*
¬gs
, **
kw¬gs
)

70 
£lf
.
	$£t
(
key
, 
rv
, 
timeout
=timeout)

72  
rv


73  
decÜ©ed_funùiÚ


74  
decÜ©Ü


77 
şass
 
	$Sim¶eCache
(
Ba£Cache
):

78 
def
 
	$__š™__
(
£lf
, 
th»shŞd
=500, 
timeout
=300):

79 
Ba£Cache
.
	$__š™__
(
£lf
, 
timeout
)

80 
£lf
.
_ÿche
 = {
	}
}

81 
£lf
.
_th»shŞd
 = 
th»shŞd


83 
def
 
	$_´uÃ
(
£lf
):

84 
	`Ën
(
£lf
.
_ÿche
è>ğ£lf.
_th»shŞd
:

85 
num
 = 
	`Ën
(
£lf
.
_ÿche
è- s–f.
_th»shŞd
 + 1

86 
key
, 
v®ue
 
š
 
	`sÜ‹d
(
£lf
.
_ÿche
.
	`™ems
(), key=
Ïmbda
 
x
:x[1][0])[:
num
]:

87 
£lf
.
_ÿche
.
	$pİ
(
key
, 
NÚe
)

89 
def
 
	$g‘
(
£lf
, 
key
):

90 
expœes
, 
v®ue
 = 
£lf
.
_ÿche
.
	`g‘
(
key
, (0, 
NÚe
))

91 
expœes
 > 
	$time
():

92  
pickË
.
	$lßds
(
v®ue
)

94 
def
 
	$£t
(
£lf
, 
key
, 
v®ue
, 
timeout
=
NÚe
):

95 
timeout
 
is
 
NÚe
:

96 
timeout
 = 
£lf
.timeout

97 
£lf
.
	$_´uÃ
()

98 
£lf
.
_ÿche
[
key
] = (
	`time
(è+ 
timeout
, 
pickË
.
	$dumps
(
v®ue
,

99 
pickË
.
HIGHEST_PROTOCOL
))

101 
def
 
	$d–‘e
(
£lf
, 
key
):

102 
£lf
.
_ÿche
.
	$pİ
(
key
, 
NÚe
)

104 
def
 
	$ş—r
(
£lf
):

105 
key
, (
expœes
, 
_
è
š
 
£lf
.
_ÿche
.
	$™”™ems
():

106 
expœes
 < 
	$time
():

107 
£lf
.
_ÿche
.
	$pİ
(
key
, 
NÚe
)

110 
ÿche
 = 
	$Sim¶eCache
()

112 
şass
 
	$ÿched_´İ”ty
(
objeù
):

113 
def
 
	$__š™__
(
£lf
, 
func
, 
Çme
=
NÚe
):

114 
£lf
.
__Çme__
 = 
Çme
 
Ü
 
func
.__name__

115 
£lf
.
__moduË__
 = 
func
.__module__

116 
£lf
.
func
 = func

118 
def
 
	$__g‘__
(
£lf
, 
obj
, 
ty³
=
NÚe
):

119 
obj
 
is
 
NÚe
:

120  
£lf


121 
v®ue
 = 
obj
.
__diù__
.
	$g‘
(
£lf
.
__Çme__
, 
NÚe
)

122 
v®ue
 
is
 
NÚe
:

123 
v®ue
 = 
£lf
.
	$func
(
obj
)

124 
obj
.
__diù__
[
£lf
.
__Çme__
] = 
v®ue


125  
v®ue


	@pypress/extensions/forms.py

1 #!/
u¤
/
bš
/
’v
 
pythÚ


2 #codšg=
utf
-8

4 
	gfÜms
.
	gpy


6 
wtfÜms
 
ex‹nsiÚs
 
	gtÜÇdo


8 
impÜt
 
»


10 
äom
 
	gtÜÇdo
.
esÿ³
 
impÜt
 
_unicode


12 
äom
 
wtfÜms
 
impÜt
 
FÜm
 
as
 
	gBa£FÜm
, 
	gf›lds
, 
	gv®id©Üs
, 
	gwidg‘s
, 
ext


14 
äom
 
	gwtfÜms
.
f›lds
 
impÜt
 
	gBoŞ—nF›ld
, 
	gDecim®F›ld
, 
	gD©eF›ld
, \

15 
	gD©eTimeF›ld
, 
	gF›ldLi¡
, 
	gFlßtF›ld
, 
	gFÜmF›ld
, \

16 
	gHidd’F›ld
, 
	gIÁeg”F›ld
, 
	gPasswÜdF›ld
, 
	gRadioF›ld
, 
	gS–eùF›ld
, \

17 
	gS–eùMuÉËF›ld
, 
	gSubm™F›ld
, 
	gTextF›ld
, 
TextA»aF›ld


19 
äom
 
	gwtfÜms
.
v®id©Üs
 
impÜt
 
	gV®id©iÚE¼Ü
, 
	gEma
, 
	gema
, 
	gEqu®To
, 
	gequ®_to
, \

20 
	gIPAdd»ss
, 
	g_add»ss
, 
	gL’gth
, 
	gËngth
, 
	gNumb”Rªge
, 
	gnumb”_¿nge
, \

21 
	gO±iÚ®
, 
	gİtiÚ®
, 
	gRequœed
, 
	g»quœed
, 
	gRegexp
, 
	g»gexp
, \

22 
	gURL
, 
	gu¾
, 
	gAnyOf
, 
	gªy_of
, 
	gNÚeOf
, 
nÚe_of


24 
äom
 
	gwtfÜms
.
widg‘s
 
impÜt
 
	gCheckboxIÅut
, 
	gFeIÅut
, 
	gHidd’IÅut
, \

25 
	gLi¡Widg‘
, 
	gPasswÜdIÅut
, 
	gRadioIÅut
, 
	gS–eù
, 
	gSubm™IÅut
, \

26 
	gTabËWidg‘
, 
	gTextA»a
, 
TextIÅut


28 
	gŒy
:

29 
impÜt
 
sqÏlchemy


30 
_is_sqÏlchemy
 = 
True


31 
exû±
 
ImpÜtE¼Ü
:

32 
_is_sqÏlchemy
 = 
F®£


35 
_is_sqÏlchemy
:

36 
äom
 
wtfÜms
.
ext
.
sqÏlchemy
.
f›lds
 
impÜt
 
Qu”yS–eùF›ld
, \

37 
Qu”yS–eùMuÉËF›ld


39 
f›ld
 
	$š
 (
Qu”yS–eùF›ld
,

40 
Qu”yS–eùMuÉËF›ld
):

42 
	$£‰r
(
f›lds
, 
f›ld
.
__Çme__
, field)

45 
şass
 
	$FÜm
(
Ba£FÜm
):

47 
Exam¶e
:

48 >>> 
u£r
 = 
U£r
.
qu”y
.
	`g‘
(1)

49 >>> 
fÜm
 = 
	$LogšFÜm
(
u£r
)

50 {{ 
x¤f_fÜm_html
 }
	}
}

51 {{ 
fÜm
.
hid’_g
() }}

52 {{ 
fÜm
.
u£ºame
 }}

55 
def
 
	$__š™__
(
£lf
, 
fÜmd©a
=
NÚe
, *
¬gs
, **
kw¬gs
):

56 
£lf
.
obj
 = 
kw¬gs
.
	`g‘
('obj', 
NÚe
)

57 
	`su³r
(
FÜm
, 
£lf
).
	$__š™__
(
fÜmd©a
, *
¬gs
, **
kw¬gs
)

59 
def
 
	$´oûss
(
£lf
, 
fÜmd©a
=
NÚe
, *
¬gs
, **
kw¬gs
):

60 
fÜmd©a
 
is
 
nÙ
 
NÚe
 
ªd
‚Ù 
	`ha§‰r
(formdata, 'getlist'):

61 
fÜmd©a
 = 
	$TÜÇdoIÅutW¿µ”
(
fÜmd©a
)

62 
	`su³r
(
FÜm
, 
£lf
).
	$´oûss
(
fÜmd©a
, *
¬gs
, **
kw¬gs
)

64 
def
 
	$hidd’_g
(
£lf
, *
f›lds
):

66 
W¿ps
 
hidd’
 
f›lds
 
š
 
a
 hidd’ 
DIV
 
g
, iÀ
Üd”
 
to
 
k“p
 
XHTML


67 
com¶Ÿnû
.

70 
nÙ
 
f›lds
:

71 
f›lds
 = [
f
 à
š
 
£lf
 
	`isš¡ªû
(f, 
Hidd’F›ld
)]

73 
rv
 = []

74 
f›ld
 
š
 
f›lds
:

75 
	$isš¡ªû
(
f›ld
, 
ba£¡ršg
):

76 
f›ld
 = 
	$g‘©Œ
(
£lf
, 
f›ld
)

77 
rv
.
	`­³nd
(
	$unicode
(
f›ld
))

79  
u
"".
	$još
(
rv
)

82 
şass
 
	$TÜÇdoIÅutW¿µ”
(
diù
):

84 
From
 
tÜÇdo
 
sourû
-> 
Reque¡HªdËr
.
g‘_¬gum’ts


86 
def
 
	$g‘li¡
(
£lf
, 
Çme
, 
¡r
=
True
):

87 
v®ues
 = []

88 
v
 
š
 
£lf
.
	$g‘
(
Çme
, []):

89 
v
 = 
	$_unicode
(
v
)

90 
	$isš¡ªû
(
v
, 
unicode
):

91 #G‘ 
rid
 
of
 
ªy
 
weœd
 
cÚŒŞ
 
	`ch¬s
 (
uÆess
 
decodšg
 
gave


92 #u 
by‹s
, 
š
 
which
 
Ëave
 
™
 
®Úe
)

93 
v
 = 
»
.
	`sub
(
r
"[\x00-\x08\x0e-\x1f]", " ", v)

94 
¡r
:

95 
v
 = v.
	$¡r
()

96 
v®ues
.
	$­³nd
(
v
)

97  
v®ues


	@pypress/extensions/permission.py

1 #!/
u¤
/
bš
/
’v
 
pythÚ


2 #codšg=
utf
-8

4 
	gex‹nsiÚs
: 
³rmissiÚ
.
py


5 
³rmissiÚ
 
tÜÇdo
. 
äom
 
æask
-
´šc®
.

6 :
modif›d
 
by
 
Ïoqiu
.
com
@
gma
.com

8 
Exam¶e
:

9 >>> 
äom
 
ex‹nsiÚs
.
³rmissiÚ
 
impÜt
 
U£rN“d
, 
	gRŞeN“d
, 
	gI‹mN“d
, 
	gP”missiÚ


10 >>> 
	gadmš
 = 
P”missiÚ
(
RŞeN“d
('admin'))

11 >>> 
ed™Ü
 = 
P”missiÚ
(
U£rN“d
(1)è& 
admš


16 @
admš
.
	$»quœe
(401)

17 
def
 
	$g‘
(
£lf
):

18 
£lf
.
	`wr™e
('is‡dmin')

21 
def
 
	$po¡
(
£lf
):

23 
ed™Ü
.
	$ÿn
(
£lf
.
id’t™y
):

24 
´št
 'admin'

26 
ed™Ü
.
	$‹¡
(
£lf
.
id’t™y
, 401)

30 
impÜt
 
sys


31 
impÜt
 
tÜÇdo
.
web


33 
äom
 
funùoŞs
 
impÜt
 
w¿ps
, 
·¹Ÿl


34 
äom
 
cŞËùiÚs
 
impÜt
 
Çmedtu¶e


36 
__®l__
 = ['UserNeed', 'RoleNeed', 'ItemNeed', 'Permission', 'Identity', 'AnonymousIdentity']

38 
N“d
 = 
	`Çmedtu¶e
('Need', ['method', 'value'])

40 
U£rN“d
 = 
	`·¹Ÿl
(
N“d
, 'user')

41 
RŞeN“d
 = 
	`·¹Ÿl
(
N“d
, 'role')

42 
I‹mN“d
 = 
	`Çmedtu¶e
('ItemNeed', ['method', 'value', 'type'])

45 
şass
 
	$P”missiÚD’›d
(
RuÁimeE¼Ü
):

47 
·ss


50 
şass
 
	$Id’t™y
(
objeù
):

52 
A
 
£t
 
of
 
Ãeds
 
´ovided
 
by
 
this
 
u£r


54 
exam¶e
:

55 
id’t™y
 = 
	`Id’t™y
('ali')

56 
id’t™y
.
´ovides
.
	`add
(('role', 'admin'))

58 
def
 
	$__š™__
(
£lf
, 
Çme
):

59 
£lf
.
Çme
 =‚ame

60 
£lf
.
´ovides
 = 
	$£t
()

62 
def
 
	$ÿn
(
£lf
, 
³rmissiÚ
):

63  
³rmissiÚ
.
	$®lows
(
£lf
)

66 
şass
 
	$AnÚymousId’t™y
(
Id’t™y
):

68 :
©Œ
 
Çme
: "anonymous"

70 
def
 
	$__š™__
(
£lf
):

71 
Id’t™y
.
	`__š™__
(
£lf
, 'anonymous')

74 
şass
 
	$Id’t™yCÚ‹xt
(
objeù
):

77 .. 
nÙe
:: 
The
 
´šc®
 
is
 
usu®ly
 
ü—‹d
 
by
 
the
 
æaskext
.
P”missiÚ
.
»quœe
 
m‘hod


78 
ÿÎ
 
nÜm®
 
u£
-
ÿ£s
.

80 
The
 
´šc®
 
behaves
 
as
 
e™h”
 
a
 
cÚ‹xt
 
mªag”
 
Ü
‡ 
decÜ©Ü
. The

81 
³rmissiÚ
 
is
 
checked
 
´ovisiÚ
 
š
 
the
 
id’t™y
, 
ªd
 
avaabË
he

82 
æow
 
is
 
	$cÚtšued
 (
cÚ‹xt
 
mªag”
è
Ü
 
the
 
funùiÚ
 
is
 
	`execu‹d
 (
decÜ©Ü
).

85 
def
 
	$__š™__
(
£lf
, 
³rmissiÚ
, 
h‰p_exû±iÚ
=
NÚe
, 
id’t™y
=None):

86 
£lf
.
³rmissiÚ
 =…ermission

87 
£lf
.
h‰p_exû±iÚ
 = http_exception

88 
£lf
.
id’t™y
 = id’t™y id’t™y 
	$AnÚymousId’t™y
()

90 
def
 
	$ÿn
(
£lf
):

93  
£lf
.
id’t™y
.
	$ÿn
(
£lf
.
³rmissiÚ
)

95 
def
 
	$__ÿÎ__
(
£lf
, 
m‘hod
):

96 @
	$w¿ps
(
m‘hod
)

97 
def
 
	$w¿µ”
(
hªdËr
, *
¬gs
, **
kw¬gs
):

98 
£lf
.
id’t™y
 = 
hªdËr
.identity

99 
£lf
.
	$__’‹r__
()

100 
exc
 = (
NÚe
, None, None)

101 
Œy
:

102 
»suÉ
 = 
	$m‘hod
(
hªdËr
, *
¬gs
, **
kw¬gs
)

103 
exû±
 
Exû±iÚ
:

104 
exc
 = 
sys
.
	$exc_šfo
()

105 
£lf
.
	$__ex™__
(*
exc
)

106  
»suÉ


107  
w¿µ”


109 
def
 
	$__’‹r__
(
£lf
):

110 #check 
the
 
³rmissiÚ
 
h”e


111 
nÙ
 
£lf
.
	$ÿn
():

112 
£lf
.
h‰p_exû±iÚ
:

113 
¿i£
 
tÜÇdo
.
web
.
	$HTTPE¼Ü
(
£lf
.
h‰p_exû±iÚ
)

114 
¿i£
 
	$P”missiÚD’›d
(
£lf
.
³rmissiÚ
)

116 
def
 
	$__ex™__
(
£lf
, *
exc
):

117 
exc
 !ğ(
NÚe
, None, None):

118 
şs
, 
v®
, 
tb
 = 
exc


119 
¿i£
 
şs
, 
v®
, 
tb


120  
F®£


123 
şass
 
	$P”missiÚ
(
objeù
):

125 
R•»£Ás
 
Ãeds
, 
ªy
 
of
 
which
 
mu¡
 
be
 
´e£Á
 
to
 
acûss
 
a
 
»sourû


126 :
·¿m
 
Ãeds
: 
The
‚“d 
this
 
³rmissiÚ


128 
def
 
	$__š™__
(
£lf
, *
Ãeds
):

129 
£lf
.
Ãeds
 = 
	$£t
(
Ãeds
)

130 
£lf
.
exşudes
 = 
	$£t
()

132 
def
 
	$__ªd__
(
£lf
, 
Ùh”
):

133 """DÛ th§mthšg‡ "
£lf
.(
Ùh”
)"

135  
£lf
.(
Ùh”
)

137 
def
 
	$__Ü__
(
£lf
, 
Ùh”
):

138 """DÛ th§mthšg‡ "
£lf
.
	`difã»nû
(
Ùh”
)"

140  
£lf
.
	$difã»nû
(
Ùh”
)

142 
def
 
	$__cÚšs__
(
£lf
, 
Ùh”
):

143 """DÛ th§mthšg‡ "
Ùh”
.
	`issub£t
(
£lf
)".

145  
Ùh”
.
	$issub£t
(
£lf
)

147 
def
 
	$»quœe
(
£lf
, 
h‰p_exû±iÚ
=
NÚe
, 
id’t™y
=None):

148  
	$Id’t™yCÚ‹xt
(
£lf
, 
h‰p_exû±iÚ
, 
id’t™y
)

150 
def
 
	$‹¡
(
£lf
, 
id’t™y
, 
h‰p_exû±iÚ
=
NÚe
):

151 
w™h
 
£lf
.
	$»quœe
(
h‰p_exû±iÚ
, 
id’t™y
):

152 
·ss


154 
def
 
	$»v”£
(
£lf
):

156 
R‘uºs
 
»v”£
 
of
 
cu¼’t
 
	`¡©e
 (
Ãeds
->
exşudes
,ƒxcludes->needs)

159 
p
 = 
	$P”missiÚ
()

160 
p
.
Ãeds
.
	$upd©e
(
£lf
.
exşudes
)

161 
p
.
exşudes
.
	$upd©e
(
£lf
.
Ãeds
)

162  
p


164 
def
 (
£lf
, 
Ùh”
):

166 
ªd
 
Ùh”
.

168 :
·¿m
 
Ùh”
: 
The
 oth” 
³rmissiÚ


170 
p
 = 
	`P”missiÚ
(*
£lf
.
Ãeds
.(
Ùh”
.needs))

171 
p
.
exşudes
.
	`upd©e
(
£lf
.exşudes.(
Ùh”
.excludes))

172  
p


174 
def
 
	$difã»nû
(
£lf
, 
Ùh”
):

176 
³rmissiÚ
 
ªd
 
nÙ
 
š
 
the
 
Ùh”
.

179 
p
 = 
	`P”missiÚ
(*
£lf
.
Ãeds
.
	$difã»nû
(
Ùh”
.
Ãeds
))

180 
p
.
exşudes
.
	`upd©e
(
£lf
.exşudes.
	$difã»nû
(
Ùh”
.
exşudes
))

181  
p


183 
def
 
	$issub£t
(
£lf
, 
Ùh”
):

186 :
·¿m
 
Ùh”
: 
The
 oth” 
³rmissiÚ


188  
£lf
.
Ãeds
.
	$issub£t
(
Ùh”
.
Ãeds
è
ªd
 \

189 
£lf
.
exşudes
.
	$issub£t
(
Ùh”
.
exşudes
)

191 
def
 
	$®lows
(
£lf
, 
id’t™y
):

194 :
·¿m
 
id’t™y
: 
The
 identity

196 
£lf
.
Ãeds
 
ªd
 
nÙ
 s–f.Ãeds.
	$š‹r£ùiÚ
(
id’t™y
.
´ovides
):

197  
F®£


199 
£lf
.
exşudes
 
ªd
 s–f.exşudes.
	$š‹r£ùiÚ
(
id’t™y
.
´ovides
):

200  
F®£


202  
True


204 
def
 
	$ÿn
(
£lf
, 
id’t™y
):

207 
This
 
ü—‹s
 
ª
 
id’t™y
 
cÚ‹xt
 
ªd
 
‹¡s
 
wh‘h”
 
™
 
ÿn
 
acûss
 
this


208 
³rmissiÚ


210  
£lf
.
	`»quœe
(
id’t™y
=id’t™y).
	`ÿn
()

	@pypress/extensions/routing.py

1 #!/
u¤
/
bš
/
’v
 
pythÚ


2 #codšg=
utf
-8

4 
	gex‹nsiÚs
.
rou‹


6 
	gExam¶e
:

7 @
rou‹
(
r
'/', 
Çme
='index')

8 
şass
 
	$IndexHªdËr
(
tÜÇdo
.
web
.
Reque¡HªdËr
):

9 
·ss


11 
şass
 
	$AµliÿtiÚ
(
tÜÇdo
.
web
.
AµliÿtiÚ
):

12 
def
 
	$__š™__
(
£lf
):

13 
hªdËrs
 = [

15 ] + 
Rou‹
.
	`rou‹s
()

18 
äom
 
tÜÇdo
.
web
 
impÜt
 
u¾


20 
şass
 
	$Rou‹
(
objeù
):

22 
_rou‹s
 = {
	}
}

24 
def
 
__š™__
(
£lf
, 
·‰”n
, 
kw¬gs
={}, 
Çme
=
NÚe
, 
ho¡
='.*$'):

25 
£lf
.
·‰”n
 =…attern

26 
£lf
.
kw¬gs
 = {}

27 
£lf
.
Çme
 =‚ame

28 
£lf
.
ho¡
 = host

30 
def
 
	$__ÿÎ__
(
£lf
, 
hªdËr_şass
):

31 
¥ec
 = 
	$u¾
(
£lf
.
·‰”n
, 
hªdËr_şass
, s–f.
kw¬gs
, 
Çme
=self.name)

32 
£lf
.
_rou‹s
.
	`£tdeçuÉ
(£lf.
ho¡
, []).
	$­³nd
(
¥ec
)

33  
hªdËr_şass


35 @
şassm‘hod


36 
def
 
	$rou‹s
(
şs
, 
­¶iÿtiÚ
=
NÚe
):

37 
­¶iÿtiÚ
:

38 
ho¡
, 
hªdËrs
 
š
 
şs
.
_rou‹s
.
	$™ems
():

39 
­¶iÿtiÚ
.
	$add_hªdËrs
(
ho¡
, 
hªdËrs
)

41  
	`»duû
(
Ïmbda
 
x
,
y
:x+y, 
şs
.
_rou‹s
.
	$v®ues
()è
şs
.
_rou‹s
 []

43 @
şassm‘hod


44 
def
 
	$u¾_fÜ
(
şs
, 
Çme
, *
¬gs
):

45 
Çmed_hªdËrs
 = 
	`diù
([(
¥ec
.
Çme
, s³cè¥eø
š
 
şs
.
	$rou‹s
(è
¥ec
.
Çme
])

46 
Çme
 
š
 
Çmed_hªdËrs
:

47  
Çmed_hªdËrs
[
Çme
].
	$»v”£
(*
¬gs
)

48 
¿i£
 
	`KeyE¼Ü
("% nÙ found iÀÇmed u¾s" % 
Çme
)

51 
rou‹
 = 
Rou‹


	@pypress/extensions/sessions.py

1 #!/
u¤
/
bš
/
’v
 
pythÚ


2 #codšg=
utf
-8

4 
	gex‹nsiÚs
.
	g£ssiÚ


6 :
Üigš
 
v”siÚ
 
š
 
h‰ps
:

8 
Œy
:

9 
impÜt
 
cPickË
 
as
 
pickË


10 
exû±
 
ImpÜtE¼Ü
:

11 
impÜt
 
pickË


12 
impÜt
 
time


13 
impÜt
 
loggšg


14 
äom
 
uuid
 
impÜt
 
uuid4


17 
şass
 
	$SessiÚ
(
objeù
):

18 
def
 
	`__š™__
(
£lf
, 
g‘_£cu»_cook›
, 
£t_£cu»_cook›
, 
Çme
='_£ssiÚ', 
expœes_days
=
NÚe
):

19 
£lf
.
£t_£ssiÚ
 = 
£t_£cu»_cook›


20 
£lf
.
g‘_£ssiÚ
 = 
g‘_£cu»_cook›


21 
£lf
.
Çme
 =‚ame

22 
£lf
.
_expœy
 = 
expœes_days


23 
£lf
.
_dœty
 = 
F®£


24 
£lf
.
	$g‘_d©a
()

26 
def
 
	$g‘_d©a
(
£lf
):

27 
v®ue
 = 
£lf
.
	$g‘_£ssiÚ
(
£lf
.
Çme
)

28 
£lf
.
_d©a
 = 
pickË
.
	$lßds
(
v®ue
èv®u{
	}
}

30 
def
 
	$£t_expœes
(
£lf
, 
days
):

31 
£lf
.
_expœy
 = 
days


33 
def
 
	$__g‘™em__
(
£lf
, 
key
):

34  
£lf
.
_d©a
[
key
]

36 
def
 
	$__£t™em__
(
£lf
, 
key
, 
v®ue
):

37 
£lf
.
_d©a
[
key
] = 
v®ue


38 
£lf
.
_dœty
 = 
True


40 
def
 
	$__d–™em__
(
£lf
, 
key
):

41 
key
 
š
 
£lf
.
_d©a
:

42 
d–
 
£lf
.
_d©a
[
key
]

43 
£lf
.
_dœty
 = 
True


45 
def
 
	$__cÚšs__
(
£lf
, 
key
):

46  
key
 
š
 
£lf
.
_d©a


48 
def
 
	$__Ën__
(
£lf
):

49  
	$Ën
(
£lf
.
_d©a
)

51 
def
 
	$__™”__
(
£lf
):

52 
key
 
š
 
£lf
.
_d©a
:

53 
y›ld
 
key


55 
def
 
	$__d–__
(
£lf
):

56 
£lf
.
	$§ve
()

58 
def
 
	$§ve
(
£lf
):

59 
£lf
.
_dœty
:

60 
£lf
.
	`£t_£ssiÚ
(£lf.
Çme
, 
pickË
.
	`dumps
(£lf.
_d©a
), 
expœes_days
=£lf.
_expœy
)

61 
£lf
.
_dœty
 = 
F®£


64 
şass
 
	$RedisSessiÚStÜe
(
objeù
):

65 
def
 
	$__š™__
(
£lf
, 
»dis_cÚÃùiÚ
, **
İtiÚs
):

66 
£lf
.
İtiÚs
 = {

69 
	}
}

70 
£lf
.
İtiÚs
.
	$upd©e
(
İtiÚs
)

71 
£lf
.
»dis
 = 
»dis_cÚÃùiÚ


73 
def
 
	$´efixed
(
£lf
, 
sid
):

74  '%s:%s' % (
£lf
.
İtiÚs
['key_´efix'], 
sid
)

76 
def
 
	$g’”©e_sid
(
£lf
):

77  
	`uuid4
().
	$g‘_hex
()

79 
def
 
	$g‘_£ssiÚ
(
£lf
, 
sid
, 
Çme
):

80 
d©a
 = 
£lf
.
»dis
.
	`hg‘
(£lf.
	`´efixed
(
sid
), 
Çme
)

81 
£ssiÚ
 = 
pickË
.
	$lßds
(
d©a
èd©¨
	$diù
()

82  
£ssiÚ


84 
def
 
	$£t_£ssiÚ
(
£lf
, 
sid
, 
£ssiÚ_d©a
, 
Çme
, 
expœy
=
NÚe
):

85 
£lf
.
»dis
.
	`h£t
(£lf.
	`´efixed
(
sid
), 
Çme
, 
pickË
.
	$dumps
(
£ssiÚ_d©a
))

86 
expœy
 =ƒxpœy 
Ü
 
£lf
.
İtiÚs
['expire']

87 
expœy
:

88 
£lf
.
»dis
.
	`expœe
(£lf.
	`´efixed
(
sid
), 
expœy
)

90 
def
 
	$d–‘e_£ssiÚ
(
£lf
, 
sid
):

91 
£lf
.
»dis
.
	`d–‘e
(£lf.
	$´efixed
(
sid
))

94 
şass
 
	$RedisSessiÚ
(
objeù
):

95 
def
 
	$__š™__
(
£lf
, 
£ssiÚ_¡Üe
, 
£ssiÚ_id
=
NÚe
, 
expœes_days
=None):

96 
£lf
.
_¡Üe
 = 
£ssiÚ_¡Üe


97 
£lf
.
_sid
 = 
£ssiÚ_id
 £ssiÚ_id £lf.
_¡Üe
.
	$g’”©e_sid
()

98 
£lf
.
_dœty
 = 
F®£


99 
£lf
.
	$£t_expœes
(
expœes_days
)

100 
Œy
:

101 
£lf
.
_d©a
 = s–f.
_¡Üe
.
	`g‘_£ssiÚ
(£lf.
_sid
, 'data')

102 
exû±
:

103 
loggšg
.
	`”rÜ
('Can‚ot connect Redis server.')

104 
£lf
.
_d©a
 = {
	}
}

106 
def
 
	$ş—r
(
£lf
):

107 
£lf
.
_¡Üe
.
	`d–‘e_£ssiÚ
(£lf.
_sid
)

109 @
´İ”ty


110 
def
 
	$id
(
£lf
):

111  
£lf
.
_sid


113 
def
 
	$acûss
(
£lf
, 
»mÙe_
):

114 
acûss_šfo
 = {'»mÙe_':
»mÙe_
, 'time':'%.6f' % 
time
.
	`time
()
	}
}

115 
£lf
.
_¡Üe
.
£t_£ssiÚ
(

116 
£lf
.
_sid
,

118 
pickË
.
	$dumps
(
acûss_šfo
))

120 
def
 
	$Ï¡_acûss
(
£lf
):

121 
acûss_šfo
 = 
£lf
.
_¡Üe
.
	`g‘_£ssiÚ
(£lf.
_sid
, 'last_access')

122  
pickË
.
	$lßds
(
acûss_šfo
)

124 
def
 
	$£t_expœes
(
£lf
, 
days
):

125 
£lf
.
_expœy
 = 
days
 * 86400 day 
NÚe


127 
def
 
	$__g‘™em__
(
£lf
, 
key
):

128  
£lf
.
_d©a
[
key
]

130 
def
 
	$__£t™em__
(
£lf
, 
key
, 
v®ue
):

131 
£lf
.
_d©a
[
key
] = 
v®ue


132 
£lf
.
_dœty
 = 
True


134 
def
 
	$__d–™em__
(
£lf
, 
key
):

135 
d–
 
£lf
.
_d©a
[
key
]

136 
£lf
.
_dœty
 = 
True


138 
def
 
	$__Ën__
(
£lf
):

139  
	$Ën
(
£lf
.
_d©a
)

141 
def
 
	$__cÚšs__
(
£lf
, 
key
):

142  
key
 
š
 
£lf
.
_d©a


144 
def
 
	$__™”__
(
£lf
):

145 
key
 
š
 
£lf
.
_d©a
:

146 
y›ld
 
key


148 
def
 
	$__»´__
(
£lf
):

149  
£lf
.
_d©a
.
	$__»´__
()

151 
def
 
	$__d–__
(
£lf
):

152 
£lf
.
	$§ve
()

154 
def
 
	$§ve
(
£lf
):

155 
£lf
.
_dœty
:

156 
£lf
.
_¡Üe
.
	`£t_£ssiÚ
(£lf.
_sid
, s–f.
_d©a
, 'd©a', s–f.
_expœy
)

157 
£lf
.
_dœty
 = 
F®£


	@pypress/extensions/signals.py

2 #!/
u¤
/
bš
/
’v
 
pythÚ


3 #codšg=
utf
-8

5 
	gsigÇls
.
	gpy


8 
Im¶em’ts
 
sigÇls
 
ba£d
 
Ú
 
blšk”
 
	gavaabË
, 
Ùh”wi£


9 
çÎs
 
s’y
 
back
 
to
 
a
 
	gnoİ


11 :
cİyright
: (
c
è2011 
by
 
Armš
 
RÚach”
.

12 :
liûn£
: 
BSD
, 
£e
 
LICENSE
 
mÜe
 
	gd‘as
.

14 
	gŒy
:

15 
äom
 
blšk”
 
impÜt
 
Name¥aû


16 
exû±
 
ImpÜtE¼Ü
:

17 
şass
 
	$Name¥aû
(
objeù
):

18 
def
 
	$sigÇl
(
£lf
, 
Çme
, 
doc
=
NÚe
):

19  
	$_FakeSigÇl
(
Çme
, 
doc
)

21 
şass
 
	$_FakeSigÇl
(
objeù
):

23 
š‹rçû
 
th©
 
®lows
 
£ndšg
 
of
 
sigÇls
 
but
 
wl
 
ç
 
w™h
 
ª


24 
”rÜ
 
Ú
 
ªythšg
 . 
In¡—d
 
of
 
došg
‡nythšg oÀ
£nd
, 
™


25 
wl
 
ju¡
 
ignÜe
 
the
 
¬gum’ts
 
ªd
 dØ
nÙhšg
 
š¡—d
.

28 
def
 
	$__š™__
(
£lf
, 
Çme
, 
doc
=
NÚe
):

29 
£lf
.
Çme
 =‚ame

30 
£lf
.
__doc__
 = 
doc


32 
def
 
	$_ç
(
£lf
, *
¬gs
, **
kw¬gs
):

33 
¿i£
 
	`RuÁimeE¼Ü
('signalling support is unavailable '

37 
£nd
 = 
Ïmbda
 *
¬gs
, **
kw¬gs
: 
NÚe


39 
cÚÃù
 = 
discÚÃù
 = 
has_»ûiv”s_fÜ
 = 
»ûiv”s_fÜ
 = \

40 
‹mpÜ¬y_cÚÃùed_to
 = 
cÚÃùed_to
 = 
_ç


42 
d–
 
_ç


45 #_sigÇl ğ
	`Name¥aû
()

47 #comm’t_§ved = 
_sigÇls
.
	`sigÇl
('comment-saved')

	@pypress/extensions/sqlalchemy.py

1 #!/
u¤
/
bš
/
’v
 
pythÚ


2 #codšg=
utf
-8

4 
	gsqÏlchemy
.
	gpy


6 :
cİyright
: (
c
è2010 
by
 
Armš
 
RÚach”
. 
From
 
æask
-
sqÏlchemy
.

7 :
liûn£
: 
BSD
, 
£e
 
LICENSE
 
mÜe
 
	gd‘as
.

9 
äom
 
__futu»__
 
impÜt
 
	gw™h_¡©em’t
, 
absŞu‹_impÜt


10 
impÜt
 
»


11 
impÜt
 
	guuid


12 #äom 
m©h
 
impÜt
 
û


13 
impÜt
 
funùoŞs


14 
äom
 
funùoŞs
 
impÜt
 
·¹Ÿl


15 
impÜt
 
sqÏlchemy


16 
äom
 
sqÏlchemy
 
impÜt
 
Üm


17 
äom
 
	gsqÏlchemy
.
	gÜm
.
£ssiÚ
 
impÜt
 
SessiÚ


18 
äom
 
	gsqÏlchemy
.
Üm
 
impÜt
 
	g©Œibu‹s
, 
objeù_m­³r


19 
äom
 
	gsqÏlchemy
.
	gÜm
.
´İ”t›s
 
impÜt
 
R–©iÚshPrİ”ty


20 
äom
 
	gsqÏlchemy
.
	gÜm
.
š‹rçûs
 
impÜt
 
	gM­³rEx‹nsiÚ
, 
	gSessiÚEx‹nsiÚ
, \

21 
EXT_CONTINUE


22 
äom
 
	gsqÏlchemy
.
	gÜm
.
exc
 
impÜt
 
Unm­³dCÏssE¼Ü


23 
äom
 
	gsqÏlchemy
.
	gext
.
deş¬©ive
 
impÜt
 
	gdeş¬©ive_ba£
, 
Deş¬©iveM‘a


24 
äom
 
	gsqÏlchemy
.
ut
 
impÜt
 
to_li¡


25 
	gäom
 .
sigÇls
 
impÜt
 
Name¥aû


27 
	gäom
 .
ÿche
 
impÜt
 
ÿched_´İ”ty


28 
impÜt
 
	gtÜÇdo
.
web


30 
	g_ÿm–ÿ£_»
 = 
»
.
compe
(
r
'([A-Z]+)(?=[a-z0-9])')

31 
_sigÇls
 = 
	$Name¥aû
()

33 
mod–s_comm™‹d
 = 
_sigÇls
.
	`sigÇl
('models-committed')

34 
befÜe_mod–s_comm™‹d
 = 
_sigÇls
.
	`sigÇl
('before-models-committed')

37 
def
 
	$_make_bË
(
db
):

38 
def
 
	$_make_bË
(*
¬gs
, **
kw¬gs
):

39 
	`Ën
(
¬gs
è> 1 
ªd
 
	$isš¡ªû
(
¬gs
[1], 
db
.
CŞumn
):

40 
¬gs
 = (¬gs[0], 
db
.
m‘ad©a
) +‡rgs[1:]

41  
sqÏlchemy
.
	$TabË
(*
¬gs
, **
kw¬gs
)

42  
_make_bË


45 
def
 
	$_£t_deçuÉ_qu”y_şass
(
d
):

46 'qu”y_şass' 
nÙ
 
š
 
d
:

47 
d
['qu”y_şass'] = 
Ba£Qu”y


50 
def
 
	$_w¿p_w™h_deçuÉ_qu”y_şass
(
â
):

51 @
funùoŞs
.
	$w¿ps
(
â
)

52 
def
 
	$Ãwâ
(*
¬gs
, **
kw¬gs
):

53 
	$_£t_deçuÉ_qu”y_şass
(
kw¬gs
)

54 "back»f" 
š
 
kw¬gs
:

55 
back»f
 = 
kw¬gs
['backref']

56 
	$isš¡ªû
(
back»f
, 
ba£¡ršg
):

57 
back»f
 = (back»f, {
	}
})

58 
	$_£t_deçuÉ_qu”y_şass
(
back»f
[1])

59  
	$â
(*
¬gs
, **
kw¬gs
)

60  
Ãwâ


63 
def
 
	$_defšes_´im¬y_key
(
d
):

65  
	`ªy
(
v
.
´im¬y_key
 
k
, v 
š
 
d
.
	$™”™ems
()

66 
	$isš¡ªû
(
v
, 
sqÏlchemy
.
CŞumn
))

69 
def
 
	$_šşude_sqÏlchemy
(
obj
):

70 
moduË
 
š
 
sqÏlchemy
, sqÏlchemy.
Üm
:

71 
key
 
š
 
moduË
.
__®l__
:

72 
nÙ
 
	$ha§‰r
(
obj
, 
key
):

73 
	`£‰r
(
obj
, 
key
, 
	$g‘©Œ
(
moduË
, 
key
))

74 #NÙe: 
obj
.
TabË
 
dÛs
 
nÙ
 
©‹m±
 
to
 
be
 
a
 
SQLAlchemy
 TabË 
şass
.

75 
obj
.
TabË
 = 
	$_make_bË
(
obj
)

76 
obj
.
m­³r
 = 
sigÇÎšg_m­³r


77 
obj
.
»ÏtiÚsh
 = 
	$_w¿p_w™h_deçuÉ_qu”y_şass
(
obj
.
»ÏtiÚsh
)

78 
obj
.
»ÏtiÚ
 = 
	$_w¿p_w™h_deçuÉ_qu”y_şass
(
obj
.
»ÏtiÚ
)

79 
obj
.
dyÇmic_lßd”
 = 
	$_w¿p_w™h_deçuÉ_qu”y_şass
(
obj
.
dyÇmic_lßd”
)

82 
şass
 
	$_BoundDeş¬©iveM‘a
(
Deş¬©iveM‘a
):

84 
def
 
	$__Ãw__
(
şs
, 
Çme
, 
ba£s
, 
d
):

85 
bËÇme
 = 
d
.
	`g‘
('__tablename__')

87 #g’”©
a
 
bË
 
Çme
 
autom©iÿÎy
 
™
's missing‡ndhe

88 #şas 
diùiÚ¬y
 
deş¬es
 
a
 
´im¬y
 
key
. 
We
 
ÿÂÙ
 
®ways


89 #©ch 
a
 
´im¬y
 
key
 
to
 
suµÜt
 
mod–
 
šh”™ªû
 
th©
 
dÛs


90 #nÙ 
u£
 
jošs
. 
We
 
®so
 
dÚ
't want‡able‚ame if‡ whole

91 #bË 
is
 
defšed


92 
nÙ
 
bËÇme
 
ªd
‚Ù 
d
.
	`g‘
('__table__')‡nd \

93 
	$_defšes_´im¬y_key
(
d
):

94 
def
 
	$_još
(
m©ch
):

95 
wÜd
 = 
m©ch
.
	$group
()

96 
	`Ën
(
wÜd
) > 1:

97  ('_%s_%s' % (
wÜd
[:-1], wÜd[-1])).
	$low”
()

98  '_' + 
wÜd
.
	$low”
()

99 
d
['__bËÇme__'] = 
_ÿm–ÿ£_»
.
	`sub
(
_još
, 
Çme
).
	`l¡r
('_')

101  
Deş¬©iveM‘a
.
	$__Ãw__
(
şs
, 
Çme
, 
ba£s
, 
d
)

103 
def
 
	$__š™__
(
£lf
, 
Çme
, 
ba£s
, 
d
):

104 
bšd_key
 = 
d
.
	`pİ
('__bšd_key__', 
NÚe
)

105 
Deş¬©iveM‘a
.
	$__š™__
(
£lf
, 
Çme
, 
ba£s
, 
d
)

106 
bšd_key
 
is
 
nÙ
 
NÚe
:

107 
£lf
.
__bË__
.
šfo
['bšd_key'] = 
bšd_key


110 
şass
 
	$_SigÇÎšgSessiÚ
(
SessiÚ
):

112 
def
 
	$__š™__
(
£lf
, 
db
, 
autocomm™
=
F®£
, 
autoæush
=F®£, **
İtiÚs
):

113 
£lf
.
£nd”
 = 
db
.sender

114 
£lf
.
_mod–_chªges
 = {
	}
}

115 
SessiÚ
.
	$__š™__
(
£lf
, 
autocomm™
÷utocomm™, 
autoæush
=autoflush,

116 
expœe_Ú_comm™
=
F®£
,

117 
ex‹nsiÚ
=
db
.
£ssiÚ_ex‹nsiÚs
,

118 
bšd
=
db
.
’gše
, **
İtiÚs
)

121 
şass
 
	$_Qu”yPrİ”ty
(
objeù
):

123 
def
 
	$__š™__
(
£lf
, 
§
):

124 
£lf
.
§
 = sa

126 
def
 
	$__g‘__
(
£lf
, 
obj
, 
ty³
):

127 
Œy
:

128 
m­³r
 = 
Üm
.
	$şass_m­³r
(
ty³
)

129 
m­³r
:

130  
ty³
.
	`qu”y_şass
(
m­³r
, 
£ssiÚ
=
£lf
.
§
.
	$£ssiÚ
())

131 
exû±
 
Unm­³dCÏssE¼Ü
:

132  
NÚe


135 
şass
 
	$_SigÇlT¿ckšgM­³rEx‹nsiÚ
(
M­³rEx‹nsiÚ
):

137 
def
 
	$aá”_d–‘e
(
£lf
, 
m­³r
, 
cÚÃùiÚ
, 
š¡ªû
):

138  
£lf
.
	`_»cÜd
(
m­³r
, 
š¡ªû
, 'delete')

140 
def
 
	$aá”_š£¹
(
£lf
, 
m­³r
, 
cÚÃùiÚ
, 
š¡ªû
):

141  
£lf
.
	`_»cÜd
(
m­³r
, 
š¡ªû
, 'insert')

143 
def
 
	$aá”_upd©e
(
£lf
, 
m­³r
, 
cÚÃùiÚ
, 
š¡ªû
):

144  
£lf
.
	`_»cÜd
(
m­³r
, 
š¡ªû
, 'update')

146 
def
 
	$_»cÜd
(
£lf
, 
m­³r
, 
mod–
, 
İ”©iÚ
):

147 
pk
 = 
	`tu¶e
(
m­³r
.
	$´im¬y_key_äom_š¡ªû
(
mod–
))

148 #Üm.
	`objeù_£ssiÚ
(
mod–
).
_mod–_chªges
[
pk
] = (mod–, 
İ”©iÚ
)

149 
chªges
 = {
	}
}

151 
´İ
 
š
 
objeù_m­³r
(
mod–
).
™”©e_´İ”t›s
:

152 
nÙ
 
	$isš¡ªû
(
´İ
, 
R–©iÚshPrİ”ty
):

153 
Œy
:

154 
hi¡Üy
 = 
©Œibu‹s
.
	$g‘_hi¡Üy
(
mod–
, 
´İ
.
key
)

155 
exû±
:

158 
added
, 
unchªged
, 
d–‘ed
 = 
hi¡Üy


160 
Ãwv®ue
 = 
added
[0] added 
NÚe


162 
İ”©iÚ
=='delete':

163 
Şdv®ue
 = 
unchªged
[0] unchªged 
NÚe


165 
Şdv®ue
 = 
d–‘ed
[0] d–‘ed 
NÚe


167 
Ãwv®ue
 
Ü
 
Şdv®ue
:

168 
chªges
[
´İ
.
key
] = (
Şdv®ue
, 
Ãwv®ue
)

170 
Üm
.
	`objeù_£ssiÚ
(
mod–
).
_mod–_chªges
[
pk
] = (mod–.
__bËÇme__
,…k[0], 
chªges
, 
İ”©iÚ
)

171  
EXT_CONTINUE


174 
şass
 
	$_SigÇÎšgSessiÚEx‹nsiÚ
(
SessiÚEx‹nsiÚ
):

176 
def
 
	$befÜe_comm™
(
£lf
, 
£ssiÚ
):

177 
d
 = 
£ssiÚ
.
_mod–_chªges


178 
d
:

179 
befÜe_mod–s_comm™‹d
.
	`£nd
(
£ssiÚ
.
£nd”
, 
chªges
=
d
.
	$v®ues
())

180  
EXT_CONTINUE


182 
def
 
	$aá”_comm™
(
£lf
, 
£ssiÚ
):

183 
d
 = 
£ssiÚ
.
_mod–_chªges


184 
d
:

185 
mod–s_comm™‹d
.
	`£nd
(
£ssiÚ
.
£nd”
, 
chªges
=
d
.
	$v®ues
())

186 
d
.
	$ş—r
()

187  
EXT_CONTINUE


189 
def
 
	$aá”_rŞlback
(
£lf
, 
£ssiÚ
):

190 
£ssiÚ
.
_mod–_chªges
.
	$ş—r
()

191  
EXT_CONTINUE


194 
def
 
	$sigÇÎšg_m­³r
(*
¬gs
, **
kw¬gs
):

196 
ex‹nsiÚs
 = 
	`to_li¡
(
kw¬gs
.
	`pİ
('ex‹nsiÚ', 
NÚe
), [])

197 
ex‹nsiÚs
.
	`­³nd
(
	$_SigÇlT¿ckšgM­³rEx‹nsiÚ
())

198 
kw¬gs
['ex‹nsiÚ'] = 
ex‹nsiÚs


199  
sqÏlchemy
.
Üm
.
	$m­³r
(*
¬gs
, **
kw¬gs
)

202 
şass
 
	$_Mod–TabËNameDesütÜ
(
objeù
):

204 
def
 
	$__g‘__
(
£lf
, 
obj
, 
ty³
):

205 
bËÇme
 = 
ty³
.
__diù__
.
	`g‘
('__tablename__')

206 
nÙ
 
bËÇme
:

207 
def
 
	$_još
(
m©ch
):

208 
wÜd
 = 
m©ch
.
	$group
()

209 
	`Ën
(
wÜd
) > 1:

210  ('_%s_%s' % (
wÜd
[:-1], wÜd[-1])).
	$low”
()

211  '_' + 
wÜd
.
	$low”
()

212 
bËÇme
 = 
_ÿm–ÿ£_»
.
	`sub
(
_još
, 
ty³
.
__Çme__
).
	`l¡r
('_')

213 
	`£‰r
(
ty³
, '__bËÇme__', 
bËÇme
)

214  
bËÇme


217 
şass
 
	$Pagš©iÚ
(
objeù
):

218 
def
 
	$__š™__
(
£lf
, 
qu”y
, 
·ge
, 
³r_·ge
=20):

219 
£lf
.
qu”y
 = query

220 
£lf
.
³r_·ge
 =…er_page

221 
max_·ge
 = 
	`max
(0, 
£lf
.
tÙ®
 - 1)

222 
£lf
.
·ge
 = 
max_·ge
 page > max_page page

224 @
ÿched_´İ”ty


225 
def
 
	$tÙ®
(
£lf
):

226  
£lf
.
qu”y
.
	`couÁ
()

228 @
ÿched_´İ”ty


229 
def
 
	$™ems
(
£lf
):

230  
£lf
.
qu”y
.
	`off£t
((£lf.
·ge
 - 1è* s–f.
³r_·ge
).
	`lim™
(£lf.³r_·ge).
	$®l
()

232 
def
 
	$™”_·ges
(
£lf
, 
Ëá_edge
=1, 
Ëá_cu¼’t
=1,

233 
right_cu¼’t
=2, 
right_edge
=1):

234 
Ï¡
 = 0

235 
num
 
š
 
	`x¿nge
(1, 
£lf
.
·ges
 + 1):

236 
num
 <ğ
Ëá_edge
 
Ü
 \

237 (
num
 > 
£lf
.
·ge
 - 
Ëá_cu¼’t
 - 1 
ªd
 \

238 
num
 < 
£lf
.
·ge
 + 
right_cu¼’t
è
Ü
 \

239 
num
 > 
£lf
.
·ges
 - 
right_edge
:

240 
Ï¡
 + 1 !ğ
num
:

241 
y›ld
 
NÚe


242 
y›ld
 
num


243 
Ï¡
 = 
num


245 @
ÿched_´İ”ty


246 
def
 
	$has_´ev
(
£lf
):

247  
£lf
.
·ge
 > 1

249 @
ÿched_´İ”ty


250 
def
 
	$´ev_num
(
£lf
):

251  
£lf
.
·ge
 - 1

253 @
ÿched_´İ”ty


254 
def
 
	$has_Ãxt
(
£lf
):

255  
£lf
.
·ge
 < s–f.
·ges


257 @
ÿched_´İ”ty


258 
def
 
	$Ãxt_num
(
£lf
):

259  
£lf
.
·ge
 + 1

261 @
ÿched_´İ”ty


262 
def
 
	$·ges
(
£lf
):

263  
	`max
(0, 
£lf
.
tÙ®
 - 1)

266 
şass
 
	$Ba£Qu”y
(
Üm
.
Qu”y
):

268 
»¶aûd
 
šdividu®
 
mod–s
 
by
 
£‰šg
 
the
 :
©Œ
:`~
Mod–
.
qu”y_şass
`

269 
©Œibu‹
. 
This
 
is
 
a
 
subşass
 
of
‡ 
¡ªd¬d
 
SQLAlchemy


270 :
şass
:`~
sqÏlchemy
.
Üm
.
qu”y
.
Qu”y
` cÏs 
ªd
 
has
 
®l
 
the
 
m‘hods
 
of
 
a


271 
¡ªd¬d
 
qu”y
 
as
 
w–l
.

273 
def
 
	$g‘_Ü_404
(
£lf
, 
id’t
):

275 
»tuºšg
 `
NÚe
`.

277 
rv
 = 
£lf
.
	$g‘
(
id’t
)

278 
rv
 
is
 
NÚe
:

279 
¿i£
 
tÜÇdo
.
web
.
	$HTTPE¼Ü
(404)

280  
rv


282 
def
 
	$fœ¡_Ü_404
(
£lf
):

284 
»tuºšg
 `
NÚe
`.

286 
rv
 = 
£lf
.
	$fœ¡
()

287 
rv
 
is
 
NÚe
:

288 
¿i£
 
tÜÇdo
.
web
.
	$HTTPE¼Ü
(404)

289  
rv


291 
def
 
	$·gš©e
(
£lf
, 
·ge
, 
³r_·ge
=20, 
”rÜ_out
=
True
):

293 
abÜt
 
w™h
 404 
no
 
™ems
 
w”e
 
found
 
ªd
 
the
 
·ge
 
was
 
Ïrg”
 
thª


294 1. 
This
 
behavÜ
 
ÿn
 
be
 
di§bËd
 
by
 
£‰šg
 `
”rÜ_out
` 
to
 `
F®£
`.

296 
R‘uºs
 
ª
 :
şass
:`
Pagš©iÚ
` 
objeù
.

298 
”rÜ_out
 
ªd
 
·ge
 < 1:

299 
¿i£
 
tÜÇdo
.
web
.
	$HTTPE¼Ü
(404)

300  
	$Pagš©iÚ
(
£lf
, 
·ge
, 
³r_·ge
)

303 
şass
 
	$Mod–
(
objeù
):

306 #: 
the
 
qu”y
 
şass
 
u£d
. 
The
 :
©Œ
:`qu”y` 
©Œibu‹
 
is
 
ª
 
š¡ªû


307 #: 
of
 
this
 
şass
. 
By
  
a
 :şass:`
Ba£Qu”y
` 
is
 
u£d
.

308 
qu”y_şass
 = 
Ba£Qu”y


310 #: 
ª
 
š¡ªû
 
of
 :
©Œ
:`
qu”y_şass
`. 
Cª
 
be
 
u£d
 
to
 
qu”y
 
the


311 #: 
d©aba£
 
š¡ªûs
 
of
 
this
 
mod–
.

312 
qu”y
 = 
NÚe


314 
PER_PAGE
 = 
NÚe


317 
şass
 
	$SQLAlchemy
(
objeù
):

319 
Exam¶e
:

320 
db
 = 
	`SQLAlchemy
("sql™e:///‹¡.db", 
True
)

322 
şass
 
	$U£r
(
db
.
Mod–
):

323 
u£ºame
 = 
db
.
	`CŞumn
(db.
	`SŒšg
(16), 
unique
=
True
, 
nuÎabË
=
F®£
, 
šdex
=True)

324 
·sswÜd
 = 
db
.
	`CŞumn
(db.
	`SŒšg
(30), 
nuÎabË
=
F®£
)

325 
ema
 = 
db
.
	`CŞumn
(db.
	`SŒšg
(30), 
nuÎabË
=
F®£
)

327 >>> 
u£r1
 = 
U£r
.
qu”y
.
	`f‹r
(U£r.
u£ºame
=='Çme').
	`fœ¡
()

328 >>> 
u£r2
 = 
U£r
.
qu”y
.
	`g‘
(1)

329 >>> 
u£r_li¡
 = 
U£r
.
qu”y
.
	`f‹r
(
db
.
	`ªd_
(U£r.
u£ºame
=='‹¡1', U£r.
ema
.
	`ike
('%@gma.com'))).
	`lim™
(10)

332 
def
 
	$__š™__
(
£lf
, 
’gše_u¾
, 
echo
=
F®£
, 
poŞ_»cyşe
=7200, 
poŞ_size
=10,

333 
£ssiÚ_ex‹nsiÚs
=
NÚe
, 
£ssiÚ_İtiÚs
=None):

334 #ü—‹ 
sigÇls
 
£nd”


335 
£lf
.
£nd”
 = 
	`¡r
(
uuid
.
	$uuid4
())

337 
£lf
.
£ssiÚ_ex‹nsiÚs
 = 
	`to_li¡
(session_extensions, []) + \

338 [
	`_SigÇÎšgSessiÚEx‹nsiÚ
()]

339 
£lf
.
£ssiÚ
 = s–f.
	$ü—‹_scİed_£ssiÚ
(
£ssiÚ_İtiÚs
)

340 
£lf
.
Mod–
 = s–f.
	$make_deş¬©ive_ba£
()

342 
£lf
.
’gše
 = 
sqÏlchemy
.
	$ü—‹_’gše
(
’gše_u¾
, 
echo
ócho, 
poŞ_»cyşe
õoŞ_»cyşe, 
poŞ_size
=pool_size)

344 
	$_šşude_sqÏlchemy
(
£lf
)

346 
def
 
	$ü—‹_scİed_£ssiÚ
(
£lf
, 
İtiÚs
=
NÚe
):

348 
İtiÚs
 
is
 
NÚe
:

349 
İtiÚs
 = {
	}
}

350  
Üm
.
scİed_£ssiÚ
(
	$·¹Ÿl
(
_SigÇÎšgSessiÚ
, 
£lf
, **
İtiÚs
))

352 
def
 
	$make_deş¬©ive_ba£
(
£lf
):

354 
ba£
 = 
	`deş¬©ive_ba£
(
şs
=
Mod–
, 
Çme
='Model',

355 
m­³r
=
sigÇÎšg_m­³r
,

356 
m‘aşass
=
_BoundDeş¬©iveM‘a
)

357 
ba£
.
qu”y
 = 
	$_Qu”yPrİ”ty
(
£lf
)

358  
ba£


360 
def
 
	$ü—‹_®l
(
£lf
):

362 
£lf
.
Mod–
.
m‘ad©a
.
	$ü—‹_®l
(
bšd
=
£lf
.
’gše
)

364 
def
 
	$drİ_®l
(
£lf
):

366 
£lf
.
Mod–
.
m‘ad©a
.
	`drİ_®l
(
bšd
=£lf.
’gše
)

	@pypress/filters.py

1 #!/
u¤
/
bš
/
’v
 
pythÚ


2 #codšg=
utf
-8

4 
impÜt
 
	gtÜÇdo
.
‹m¶©e


7 
def
 
	$f›ld_”rÜs
(
f›ld
):

8 
t
 = 
tÜÇdo
.
‹m¶©e
.
	`Tem¶©e
("""

9 {% 
f›ld
.
”rÜs
 %}

10 <
ul
 
şass
="errors">

11 {% 
”rÜ
 
š
 
f›ld
.
”rÜs
 %}

12 <
li
>{{ 
”rÜ
 }}</li>

13 {% 
’d
 %}

14 </
ul
>

15 {% 
’d
 %}

17  
t
.
	`g’”©e
(
f›ld
=field)

	@pypress/forms.py

1 #!/
u¤
/
bš
/
’v
 
pythÚ


2 #codšg=
utf
-8

3 
impÜt
 
	gtÜÇdo
.
loÿË


5 
äom
 
	gpy´ess
.
	gex‹nsiÚs
.
fÜms
 
impÜt
 
	gFÜm
, 
	gTextF›ld
, 
	gPasswÜdF›ld
, 
	gSubm™F›ld
, \

6 
	gTextA»aF›ld
, 
	gBoŞ—nF›ld
, 
	gHidd’F›ld
, 
	gV®id©iÚE¼Ü
, \

7 
	g»quœed
, 
	g»gexp
, 
	gequ®_to
, 
	gema
, 
	gİtiÚ®
, 
u¾


9 
äom
 
	gpy´ess
.
mod–s
 
impÜt
 
	gU£r
, 
Po¡


10 
äom
 
	gpy´ess
.
h–³rs
 
impÜt
 
¦ugify


11 
äom
 
	gpy´ess
.
d©aba£
 
impÜt
 
db


13 
	gUSERNAME_RE
 = 
r
'^[\w.+-]+$'

16 
def
 
	$ü—‹_fÜms
():

18 
_fÜms
 = {
	}
}

20 
loÿË
 
š
 
tÜÇdo
.loÿË.
	$g‘_suµÜ‹d_loÿËs
():

22 
_
 = 
tÜÇdo
.
loÿË
.
	`g‘
ÖoÿË).
Œª¦©e


23 #loggšg.
	`šfo
('ü—‹ fÜms: %s' % 
loÿË
)

25 
is_u£ºame
 = 
	`»gexp
(
USERNAME_RE
,

26 
mes§ge
=
	`_
("You can only use†etters,‚umbers or dashes"))

28 
şass
 
	$FÜmW¿µ”
(
objeù
):

30 
şass
 
	$LogšFÜm
(
FÜm
):

31 
logš
 = 
	`TextF›ld
(
	`_
("U£ºamÜƒma"), 
v®id©Üs
=[

32 
	`»quœed
(
mes§ge
=\

33 
	`_
("You must…rovide‡nƒmail or username"))])

35 
·sswÜd
 = 
	`PasswÜdF›ld
(
	`_
("Password"))

37 
»memb”
 = 
	`BoŞ—nF›ld
(
	`_
("Remember me"))

39 
Ãxt
 = 
	$Hidd’F›ld
()

41 
subm™
 = 
	`Subm™F›ld
(
	`_
("Login"))

44 
şass
 
	$SignupFÜm
(
FÜm
):

45 
u£ºame
 = 
	`TextF›ld
(
	`_
("U£ºame"), 
v®id©Üs
=[

46 
	`»quœed
(
mes§ge
=
	`_
("Username„equired")),

47 
is_u£ºame
])

49 
nickÇme
 = 
	`TextF›ld
(
	`_
("NickÇme"), 
v®id©Üs
=[

50 
	`»quœed
(
mes§ge
=
	`_
("Nickname„equired"))])

52 
·sswÜd
 = 
	`PasswÜdF›ld
(
	`_
("PasswÜd"), 
v®id©Üs
=[

53 
	`»quœed
(
mes§ge
=
	`_
("Password„equired"))])

55 
·sswÜd_agaš
 = 
	`PasswÜdF›ld
(
	`_
("PasswÜd‡gaš"), 
v®id©Üs
=[

56 
	`equ®_to
("·sswÜd", 
mes§ge
=\

57 
	`_
("Passwords don't match"))])

59 
ema
 = 
	`TextF›ld
(
	`_
("Ema"), 
v®id©Üs
=[

60 
	`»quœed
(
mes§ge
=
	`_
("Email„equired")),

61 
	`ema
(
mes§ge
=
	`_
("A validƒmail is„equired"))])

63 
code
 = 
	`TextF›ld
(
	`_
("Signup Code"))

65 
Ãxt
 = 
	$Hidd’F›ld
()

67 
subm™
 = 
	`Subm™F›ld
(
	`_
("Signup"))

69 
def
 
	$v®id©e_u£ºame
(
£lf
, 
f›ld
):

70 
u£r
 = 
U£r
.
qu”y
.
	`f‹r
(U£r.
u£ºame
.
	`like
(
f›ld
.
d©a
)).
	$fœ¡
()

71 
u£r
:

72 
¿i£
 
V®id©iÚE¼Ü
, 
	`_
("This username isaken")

74 
def
 
	$v®id©e_ema
(
£lf
, 
f›ld
):

75 
u£r
 = 
U£r
.
qu”y
.
	`f‹r
(U£r.
ema
.
	`like
(
f›ld
.
d©a
)).
	$fœ¡
()

76 
u£r
:

77 
¿i£
 
V®id©iÚE¼Ü
, 
	`_
("Thisƒmail isaken")

80 
şass
 
	$Recov”PasswÜdFÜm
(
FÜm
):

81 
ema
 = 
	`TextF›ld
(
	`_
("You¸ema‡dd»ss"), 
v®id©Üs
=[

82 
	`ema
(
mes§ge
=
	`_
("A validƒmail is„equired"))])

84 
subm™
 = 
	`Subm™F›ld
(
	`_
("Find…assword"))

87 
şass
 
	$ChªgePasswÜdFÜm
(
FÜm
):

88 
·sswÜd_Şd
 = 
	`PasswÜdF›ld
(
	`_
("PasswÜd"), 
v®id©Üs
=[

89 
	`»quœed
(
mes§ge
=
	`_
("Password is„equired"))])

91 
·sswÜd
 = 
	`PasswÜdF›ld
(
	`_
("New PasswÜd"), 
v®id©Üs
=[

92 
	`»quœed
(
mes§ge
=
	`_
("New Password is„equired"))])

94 
·sswÜd_agaš
 = 
	`PasswÜdF›ld
(
	`_
("PasswÜd‡gaš"), 
v®id©Üs
=[

95 
	`equ®_to
("·sswÜd", 
mes§ge
=\

96 
	`_
("Passwords don't match"))])

98 
subm™
 = 
	`Subm™F›ld
(
	`_
("Save"))

101 
şass
 
	$D–‘eAccouÁFÜm
(
FÜm
):

102 
»ÿ±cha
 = 
	`TextF›ld
(
	`_
("Recaptcha"))

104 
subm™
 = 
	`Subm™F›ld
(
	`_
("Delete"))

107 
şass
 
	$Po¡FÜm
(
FÜm
):

108 
t™Ë
 = 
	`TextF›ld
(
	`_
("T™Ë"), 
v®id©Üs
=[

109 
	`»quœed
(
mes§ge
=
	`_
("Title„equired"))])

111 
¦ug
 = 
	`TextF›ld
(
	`_
("Slug"))

113 
cÚ‹Á
 = 
	`TextA»aF›ld
(
	`_
("CÚ‹Á"), 
v®id©Üs
=[

114 
	`»quœed
(
mes§ge
=
	`_
("Content„equired"))])

116 
gs
 = 
	`TextF›ld
(
	`_
("Tags"), 
v®id©Üs
=[

117 
	`»quœed
(
mes§ge
=
	`_
("Tags„equired"))])

119 
subm™
 = 
	`Subm™F›ld
(
	`_
("Save"))

121 
Ãxt
 = 
	$Hidd’F›ld
()

123 
def
 
	$v®id©e_¦ug
(
£lf
, 
f›ld
):

124 
	`Ën
(
f›ld
.
d©a
) > 50:

125 
¿i£
 
V®id©iÚE¼Ü
, 
	`_
("Slug must be†esshan 50 characters")

126 
¦ug
 = 
	$¦ugify
(
f›ld
.
d©a
èf›ld.d©¨
	`¦ugify
(
£lf
.
t™Ë
.data)[:50]

127 
po¡s
 = 
Po¡
.
qu”y
.
	$f‹r_by
(
¦ug
=slug)

128 
£lf
.
obj
:

129 
po¡s
 =…o¡s.
	`f‹r
(
db
.
	$nÙ_
(
Po¡
.
id
==
£lf
.
obj
.id))

130 
po¡s
.
	$couÁ
():

131 
”rÜ
 = 
	`_
("Thi ¦ug i k’"è
f›ld
.
d©a
 _("Slug is„equired")

132 
¿i£
 
V®id©iÚE¼Ü
, 
”rÜ


135 
şass
 
	$Comm’tFÜm
(
FÜm
):

136 
ema
 = 
	`TextF›ld
(
	`_
("Ema"), 
v®id©Üs
=[

137 
	`»quœed
(
mes§ge
=
	`_
("Email„equired")),

138 
	`ema
(
mes§ge
=
	`_
("A validƒmail is„equired"))])

140 
nickÇme
 = 
	`TextF›ld
(
	`_
("NickÇme"), 
v®id©Üs
=[

141 
	`»quœed
(
mes§ge
=
	`_
("Nickname„equired"))])

143 
webs™e
 = 
	`TextF›ld
(
	`_
("Webs™e"), 
v®id©Üs
=[

144 
	`İtiÚ®
(),

145 
	`u¾
(
mes§ge
=
	`_
("A valid url is„equired"))])

147 
comm’t
 = 
	`TextA»aF›ld
(
	`_
("Comm’t"), 
v®id©Üs
=[

148 
	`»quœed
(
mes§ge
=
	`_
("Comment„equired"))])

150 
ÿ±cha
 = 
	`TextF›ld
(
	`_
("C­tcha"), 
v®id©Üs
=[

151 
	`»quœed
(
mes§ge
=
	`_
("Captcha„equired"))])

153 
subm™
 = 
	`Subm™F›ld
(
	`_
("Add comment"))

154 
ÿnûl
 = 
	`Subm™F›ld
(
	`_
("Cancel"))

157 
şass
 
	$LškFÜm
(
FÜm
):

158 
Çme
 = 
	`TextF›ld
(
	`_
("S™Çme"), 
v®id©Üs
=[

159 
	`»quœed
(
mes§ge
=
	`_
("Site‚ame„equired"))])

161 
lšk
 = 
	`TextF›ld
(
	`_
("lšk"), 
v®id©Üs
=[

162 
	`u¾
(
mes§ge
=
	`_
("A valid url is„equired"))])

164 
ema
 = 
	`TextF›ld
(
	`_
("Ema"), 
v®id©Üs
=[

165 
	`ema
(
mes§ge
=
	`_
("A validƒmail is„equired"))])

167 
logo
 = 
	`TextF›ld
(
	`_
("Logo"), 
v®id©Üs
=[

168 
	`İtiÚ®
(),

169 
	`u¾
(
mes§ge
=
	`_
("A valid url is„equired"))])

171 
desütiÚ
 = 
	`TextA»aF›ld
(
	`_
("Description"))

173 
subm™
 = 
	`Subm™F›ld
(
	`_
("Save"))

176 
_fÜms
[
loÿË
] = 
FÜmW¿µ”


178  
_fÜms


	@pypress/helpers.py

1 #!/
u¤
/
bš
/
’v
 
pythÚ


2 #codšg=
utf
-8

4 
	gh–³rs
.
	gpy


6 :
authÜ
: 
Ïoqiu
.
com
@
gma
.com

8 
impÜt
 
»


9 
impÜt
 
m¬kdown


10 
impÜt
 
funùoŞs


11 
impÜt
 
hashlib


12 
impÜt
 
¿ndom


14 
äom
 
pygm’ts
 
impÜt
 
highlight


15 
äom
 
pygm’ts
.
Ëx”s
 
impÜt
 
g‘_Ëx”_by_Çme


16 
äom
 
pygm’ts
.
fÜm©‹rs
 
impÜt
 
HtmlFÜm©‹r


19 
_punù_»
 = 
»
.
compe
(
r
'[\t !"#$%&\'()*\-/<=>?@\[\\\]^_`{|},.]+')

20 
_´e_»
 = 
»
.
compe
(
r
'<pre (?=lang=[\'"]?\w+[\'"]?).*?>(?P<code>[\w\W]+?)</pre>')

21 
_Ïng_»
 = 
»
.
compe
(
r
'lang=[\'"]?(?P<lang>\w+)[\'"]?')

24 
şass
 
	$StÜage
(
diù
):

26 
A
 
StÜage
 
objeù
 
is
 
like
 
a
 
diùiÚ¬y
 
exû±
 `
obj
.
foo
` 
ÿn
 
be
 
u£d


27 
š
 
add™iÚ
 
to
 `
obj
['foo']`.

28 >>> 
o
 = 
	`¡Üage
(
a
=1)

29 >>> 
o
.
a


31 >>> 
o
['a']

33 >>> 
o
.
a
 = 2

34 >>> 
o
['a']

36 >>> 
d–
 
o
.
a


37 >>> 
o
.
a


38 
	$T¿ûback
 (
mo¡
 
»ûÁ
 
ÿÎ
 
Ï¡
):

40 
A‰ribu‹E¼Ü
: 'a'

42 
def
 
	$__g‘©Œ__
(
£lf
, 
key
):

43 
Œy
:

44  
£lf
[
key
]

45 
exû±
 
KeyE¼Ü
, 
k
:

46 
¿i£
 
A‰ribu‹E¼Ü
, 
k


48 
def
 
	$__£‰r__
(
£lf
, 
key
, 
v®ue
):

49 
£lf
[
key
] = 
v®ue


51 
def
 
	$__d–©Œ__
(
£lf
, 
key
):

52 
Œy
:

53 
d–
 
£lf
[
key
]

54 
exû±
 
KeyE¼Ü
, 
k
:

55 
¿i£
 
A‰ribu‹E¼Ü
, 
k


57 
def
 
	$__»´__
(
£lf
):

58  '<StÜag' + 
diù
.
	`__»´__
(
£lf
) + '>'

61 
şass
 
	$G¿v©¬
(
objeù
):

63 
Sim¶e
 
objeù
 
ü—‹
 
g¿v©¬
 
lšk
.

65 
g¿v©¬
 = 
	`G¿v©¬
(

66 
size
=100,

67 
¿tšg
='g',

69 
fÜû_deçuÉ
=
F®£
,

70 
fÜû_low”
=
F®£


73 :
·¿m
 
­p
: 
Your
 
FÏsk
‡µ 
š¡ªû


74 :
·¿m
 
size
: 
DeçuÉ
 siz
av©¬


75 :
·¿m
 
¿tšg
: 
DeçuÉ
„ating

76 :
·¿m
 : 
DeçuÉ
 
ty³
 
uÄegi¡»d
 
emas


77 :
·¿m
 
fÜû_deçuÉ
: 
Bud
 
Úly
  
av©¬s


78 :
·¿m
 
fÜû_low”
: 
Make
 
ema
.
	$low”
(è
befÜe
 
bud
 
lšk


80 
From
 
æask
-
g¿v©¬
 
h‰p
:

83 
def
 
	`__š™__
(
£lf
, 
size
=100, 
¿tšg
='g', ='mm',

84 
fÜû_deçuÉ
=
F®£
, 
fÜû_low”
=False):

86 
£lf
.
size
 = size

87 
£lf
.
¿tšg
 =„ating

88 
£lf
. = 

89 
£lf
.
fÜû_deçuÉ
 = force_default

91 
def
 
	$__ÿÎ__
(
£lf
, 
ema
, 
size
=
NÚe
, 
¿tšg
=None, =None,

92 
fÜû_deçuÉ
=
NÚe
, 
fÜû_low”
=
F®£
):

96 
size
 
is
 
NÚe
:

97 
size
 = 
£lf
.size

99 
¿tšg
 
is
 
NÚe
:

100 
¿tšg
 = 
£lf
.rating

102  
is
 
NÚe
:

103  = 
£lf
.

105 
fÜû_deçuÉ
 
is
 
NÚe
:

106 
fÜû_deçuÉ
 = 
£lf
.force_default

108 
fÜû_low”
 
is
 
NÚe
:

109 
fÜû_low”
 = 
£lf
.force_lower

111 
fÜû_low”
:

112 
ema
 =ƒma.
	$low”
()

114 
hash
 = 
hashlib
.
	`md5
(
ema
).
	$hexdige¡
()

116 
lšk
 = 'http://www.gravatar.com/avatar/{hash}'\

117 '?s={size}&d={deçuÉ}&r={¿tšg}'.
	`fÜm©
(**
	$loÿls
())

119 
fÜû_deçuÉ
:

120 
lšk
 =†ink + '&f=y'

122  
lšk


125 
def
 
	$£‰šg_äom_objeù
(
obj
):

126 
£‰šgs
 = 
	$diù
()

127 
key
 
š
 
	$dœ
(
obj
):

128 
key
.
	$isuµ”
():

129 
£‰šgs
[
key
.
	`low”
()] = 
	$g‘©Œ
(
obj
, 
key
)

130  
£‰šgs


133 
def
 
	`¦ugify
(
‹xt
, 
d–im
=
u
'-'):

135 
»suÉ
 = []

136 
wÜd
 
š
 
_punù_»
.
	`¥l™
(
‹xt
.
	$low”
()):

137 #wÜd = 
wÜd
.
	`’code
('translit/long')

138 
wÜd
:

139 
»suÉ
.
	$­³nd
(
wÜd
)

140  
	`unicode
(
d–im
.
	$još
(
»suÉ
))

143 
def
 
	$g’”©e_¿ndom
(
Ëngth
=8):

145  ''.
	`još
([
	`¡r
(
¿ndom
.
	$¿ndšt
(0, 9)è
i
 
š
 
	`¿nge
(
Ëngth
)])

148 
def
 
	$’dgs
(
html
):

151 
NON_CLOSING_TAGS
 = ['AREA', 'BASE', 'BASEFONT', 'BR', 'COL', 'FRAME',

154 
İ’ed_gs
 = 
»
.
	`fšd®l
(
r
"<([a-z]+)[^<>]*>",
html
)

155 
şo£d_gs
 = 
»
.
	`fšd®l
(
r
"</([a-z]+)>",
html
)

157 
İ’ed_gs
 = [
i
.
	$low”
(è
i
 
š
 
İ’ed_gs
 i.
	$uµ”
(è
nÙ
 
š
 
NON_CLOSING_TAGS
]

158 
şo£d_gs
 = [
i
.
	$low”
(è
i
 
š
 
şo£d_gs
]

160 
Ën_İ’ed
 = 
	$Ën
(
İ’ed_gs
)

162 
Ën_İ’ed
==
	$Ën
(
şo£d_gs
):

163  
html


165 
İ’ed_gs
.
	$»v”£
()

167 
g
 
š
 
İ’ed_gs
:

168 
g
 
š
 
şo£d_gs
:

169 
şo£d_gs
.
	$»move
(
g
)

171 
html
 +ğ"</%s>" % 
g


173  
html


176 
def
 
	$gi¡code
(
cÚ‹Á
):

177 
»suÉ
 = 
	`li¡
(
	`£t
(
»
.
	`fšd®l
(
r
"(<a[^<>]*>\s*(h‰ps://gi¡.g™hub.com/\d+)\s*</a>)", 
cÚ‹Á
)))

178 
i
,
lšk
 
š
 
»suÉ
:

179 
cÚ‹Á
 = cÚ‹Á.
	`»¶aû
(
i
, '% <süˆ¤c="%s.js"></süt>' % (i, 
lšk
))

180  
cÚ‹Á


183 
def
 
	$code_highlight
(
v®ue
):

184 
f_li¡
 = 
_´e_»
.
	$fšd®l
(
v®ue
)

186 
f_li¡
:

187 
s_li¡
 = 
_´e_»
.
	$¥l™
(
v®ue
)

189 
code_block
 
š
 
_´e_»
.
	$fšd™”
(
v®ue
):

191 
Ïng
 = 
_Ïng_»
.
	`£¬ch
(
code_block
.
	`group
()).group('lang')

192 
code
 = 
code_block
.
	`group
('code')

194 
šdex
 = 
s_li¡
.
	$šdex
(
code
)

195 
s_li¡
[
šdex
] = 
	$code2html
(
code
, 
Ïng
)

197  
u
''.
	$još
(
s_li¡
)

199  
v®ue


202 
def
 
	$code2html
(
code
, 
Ïng
):

203 
Ëx”
 = 
	$g‘_Ëx”_by_Çme
(
Ïng
, 
¡r®l
=
True
)

204 
fÜm©‹r
 = 
	$HtmlFÜm©‹r
()

205  
	$highlight
(
code
, 
Ëx”
, 
fÜm©‹r
)

208 
m¬kdown
 = 
funùoŞs
.
	`·¹Ÿl
(markdown.markdown,

209 
§ã_mode
='remove',

210 
ouut_fÜm©
="html")

212 
¡Üage
 = 
StÜage


213 
g¿v©¬
 = 
	`G¿v©¬
()

	@pypress/local_settings.py

1 #!/
u¤
/
bš
/
’v
 
pythÚ


2 #codšg=
utf
-8

4 
	gSQLALCHEMY_DATABASE_URI
 = "mysql://pypress:pypress@localhost/pypress?charset=utf8"

5 
SQLALCHEMY_DATABASE_ECHO
 = 
F®£


	@pypress/models/__init__.py

1 #!/
u¤
/
bš
/
’v
 
pythÚ


2 
	gäom
 .
u£rs
 
impÜt
 *

3 
	gäom
 .
blog
 
impÜt
 *

4 
	gäom
 .
lšks
 
	gimpÜt
 *

	@pypress/models/blog.py

1 #!/
u¤
/
bš
/
’v
 
pythÚ


2 #codšg=
utf
-8

4 
	gmod–s
: 
blog
.
py


6 :
authÜ
: 
Ïoqiu
.
com
@
gma
.com

9 
impÜt
 
»
, 
¿ndom


10 
äom
 
d©‘ime
 
impÜt
 datetime

12 
impÜt
 
	gtÜÇdo
.
web


14 
äom
 
	gpy´ess
.
	gex‹nsiÚs
.
sqÏlchemy
 
impÜt
 
Ba£Qu”y


15 
äom
 
	gpy´ess
.
	gex‹nsiÚs
.
ÿche
 
impÜt
 
	gÿched_´İ”ty
, cache

16 
äom
 
	gpy´ess
.
	gex‹nsiÚs
.
routšg
 
impÜt
 
rou‹


17 
äom
 
	gpy´ess
.
	gex‹nsiÚs
.
³rmissiÚ
 
impÜt
 
	gP”missiÚ
, 
U£rN“d


18 
äom
 
	gpy´ess
.
h–³rs
 
impÜt
 
	g¡Üage
, 
	g¦ugify
, 
	gm¬kdown
, 
’dgs


19 
äom
 
	gpy´ess
.
³rmissiÚs
 
impÜt
 
	gadmš
, 
mod”©Ü


20 
äom
 
	gpy´ess
.
d©aba£
 
impÜt
 
db


21 
äom
 
	gpy´ess
.
	gmod–s
.
u£rs
 
impÜt
 
U£r


24 
	g__®l__
 = ['Post', 'Tag', 'Comment']

27 
şass
 
	$Po¡Qu”y
(
Ba£Qu”y
):

29 
def
 
	$jsÚify
(
£lf
):

30 
po¡
 
š
 
£lf
.
	$®l
():

31 
y›ld
 
po¡
.
jsÚ


33 
def
 
	$as_li¡
(
£lf
):

35 
R‘uº
 
»¡riùed
 
li¡
 
of
 
cŞumns
 li¡ 
qu”›s


38 
deã¼ed_cŞs
 = ("content",

45 
İtiÚs
 = [
db
.
	$deãr
(
cŞ
ècŞ 
š
 
deã¼ed_cŞs
]

46  
£lf
.
	$İtiÚs
(*
İtiÚs
)

48 
def
 
	$g‘_by_¦ug
(
£lf
, 
¦ug
):

49 
po¡
 = 
£lf
.
	`f‹r
(
Po¡
.
¦ug
==¦ug).
	$fœ¡
()

50 
po¡
 
is
 
NÚe
:

51 
¿i£
 
tÜÇdo
.
web
.
	$HTTPE¼Ü
(404)

52  
po¡


54 
def
 
	$£¬ch
(
£lf
, 
keywÜds
):

56 
ü™”Ÿ
 = []

58 
keywÜd
 
š
 
keywÜds
.
	$¥l™
():

59 
keywÜd
 = '%' + keyword + '%'

60 
ü™”Ÿ
.
	`­³nd
(
db
.
	`Ü_
(
Po¡
.
t™Ë
.
	`ike
(
keywÜd
),

61 
Po¡
.
cÚ‹Á
.
	`ike
(
keywÜd
),

62 
Po¡
.
gs
.
	$ike
(
keywÜd
)

65 
q
 = 
	$»duû
(
db
.
ªd_
, 
ü™”Ÿ
)

66  
£lf
.
	$f‹r
(
q
)

68 
def
 
	$¬chive
(
£lf
, 
y—r
, 
mÚth
, 
day
):

69 
nÙ
 
y—r
:

70  
£lf


72 
ü™”Ÿ
 = []

73 
ü™”Ÿ
.
	`­³nd
(
db
.
	`exŒaù
('y—r',
Po¡
.
ü—‹d_d©e
)==(
y—r
))

74 
mÚth
: 
ü™”Ÿ
.
	`­³nd
(
db
.
	`exŒaù
('mÚth',
Po¡
.
ü—‹d_d©e
)==(month))

75 
day
: 
ü™”Ÿ
.
	`­³nd
(
db
.
	`exŒaù
('day',
Po¡
.
ü—‹d_d©e
)==(day))

77 
q
 = 
	$»duû
(
db
.
ªd_
, 
ü™”Ÿ
)

78  
£lf
.
	$f‹r
(
q
)

81 
şass
 
	$Po¡
(
db
.
Mod–
):

83 
__bËÇme__
 = 'posts'

85 
PER_PAGE
 = 40

87 
qu”y_şass
 = 
Po¡Qu”y


89 
id
 = 
db
.
	$CŞumn
(
db
.
IÁeg”
, 
´im¬y_key
=
True
)

91 
authÜ_id
 = 
db
.
	`CŞumn
(db.
IÁeg”
,

92 
db
.
	`FÜeignKey
(
U£r
.
id
, 
Úd–‘e
='CASCADE'),

93 
nuÎabË
=
F®£
)

95 
_t™Ë
 = 
db
.
	`CŞumn
("t™Ë", db.
	`Unicode
(100), 
šdex
=
True
)

96 
_¦ug
 = 
db
.
	`CŞumn
("¦ug", db.
	`Unicode
(50), 
unique
=
True
, 
šdex
=True)

97 
cÚ‹Á
 = 
db
.
	$CŞumn
(
db
.
UnicodeText
)

98 
ü—‹d_d©e
 = 
db
.
	$CŞumn
(
db
.
D©eTime
, =
d©‘ime
.
utúow
)

99 
upd©e_time
 = 
db
.
	$CŞumn
(
db
.
D©eTime
, =
d©‘ime
.
utúow
, 
Úupd©e
=datetime.utcnow)

101 
_gs
 = 
db
.
	`CŞumn
("gs", db.
	`Unicode
(100), 
šdex
=
True
)

103 
authÜ
 = 
db
.
	`»ÏtiÚ
(
U£r
, 
šÃrjoš
=
True
, 
Ïzy
="joined")

105 
__m­³r_¬gs__
 = {'Üd”_by': 
id
.
	`desc
()
	}
}

107 
şass
 
	$P”missiÚs
(
objeù
):

109 
def
 
	$__š™__
(
£lf
, 
obj
):

110 
£lf
.
obj
 = obj

112 @
ÿched_´İ”ty


113 
def
 
	$ed™
(
£lf
):

114  
	`P”missiÚ
(
	`U£rN“d
(
£lf
.
obj
.
authÜ_id
))

116 @
ÿched_´İ”ty


117 
def
 
	$d–‘e
(
£lf
):

118  
	`P”missiÚ
(
	$U£rN“d
(
£lf
.
obj
.
authÜ_id
))

121 
def
 
	$__š™__
(
£lf
, *
¬gs
, **
kw¬gs
):

122 
	`su³r
(
Po¡
, 
£lf
).
	$__š™__
(*
¬gs
, **
kw¬gs
)

124 
def
 
	$__¡r__
(
£lf
):

125  
£lf
.
t™Ë


127 
def
 
	$__»´__
(
£lf
):

128  "<%s>" % 
£lf


130 @
ÿched_´İ”ty


131 
def
 
	$³rmissiÚs
(
£lf
):

132  
£lf
.
	$P”missiÚs
(
£lf
)

134 
def
 
	$_g‘_t™Ë
(
£lf
):

135  
£lf
.
_t™Ë


137 
def
 
	$_£t_t™Ë
(
£lf
, 
t™Ë
):

138 
£lf
.
_t™Ë
 = 
t™Ë
.
	`low”
().
	$¡r
()

139 
£lf
.
¦ug
 
is
 
NÚe
:

140 
£lf
.
¦ug
 = 
	`¦ugify
(
t™Ë
)[:50]

142 
t™Ë
 = 
db
.
	`synÚym
("_t™Ë", 
desütÜ
=
	$´İ”ty
(
_g‘_t™Ë
, 
_£t_t™Ë
))

144 
def
 
	$_g‘_¦ug
(
£lf
):

145  
£lf
.
_¦ug


147 
def
 
	$_£t_¦ug
(
£lf
, 
¦ug
):

148 
¦ug
:

149 
£lf
.
_¦ug
 = 
	$¦ugify
(
¦ug
)

151 
¦ug
 = 
db
.
	`synÚym
("_¦ug", 
desütÜ
=
	$´İ”ty
(
_g‘_¦ug
, 
_£t_¦ug
))

153 
def
 
	$_g‘_gs
(
£lf
):

154  
£lf
.
_gs


156 
def
 
	$_£t_gs
(
£lf
, 
gs
):

158 
£lf
.
_gs
 = 
gs


160 
£lf
.
id
:

161 #’su» 
exi¡šg
 
g
 
»ã»nûs
 
¬e
 
»moved


162 
d
 = 
db
.
	$d–‘e
(
po¡_gs
,…o¡_gs.
c
.
po¡_id
==
£lf
.
id
)

163 
db
.
’gše
.
	$execu‹
(
d
)

165 
g
 
š
 
	$£t
(
£lf
.
gli¡
):

167 
¦ug
 = 
	$¦ugify
(
g
)

169 
g_obj
 = 
Tag
.
qu”y
.
	`f‹r
(Tag.
¦ug
==¦ug).
	$fœ¡
()

170 
g_obj
 
is
 
NÚe
:

171 
g_obj
 = 
	$Tag
(
Çme
=
g
, 
¦ug
=slug)

172 
db
.
£ssiÚ
.
	$add
(
g_obj
)

174 
g_obj
.
po¡s
.
	$­³nd
(
£lf
)

176 
gs
 = 
db
.
	`synÚym
("_gs", 
desütÜ
=
	`´İ”ty
(
_g‘_gs
, 
_£t_gs
))

178 @
ÿched_´İ”ty


179 
def
 
	$u¾
(
£lf
):

180  
rou‹
.
	`u¾_fÜ
('post_view',

181 
£lf
.
ü—‹d_d©e
.
y—r
,

182 
£lf
.
ü—‹d_d©e
.
mÚth
,

183 
£lf
.
ü—‹d_d©e
.
day
,

184 
£lf
.
¦ug
.
	`’code
('utf8'))

186 @
ÿched_´İ”ty


187 
def
 
	$gli¡
(
£lf
):

188 
£lf
.
gs
 
is
 
NÚe
:

191 
gs
 = [
t
.
	$¡r
(è
t
 
š
 
£lf
.
gs
.
	`¥l™
(",")]

192  [
t
 ˆ
š
 
gs
 t]

194 @
ÿched_´İ”ty


195 
def
 
	$lšked_gli¡
(
£lf
):

196  [(
g
, 
rou‹
.
	`u¾_fÜ
('g', 
	`¦ugify
(tag))) \

197 
g
 
š
 
£lf
.
gli¡
]

199 @
ÿched_´İ”ty


200 
def
 
	$´ev_po¡
(
£lf
):

201 
´ev_po¡
 = 
Po¡
.
qu”y
.
	`f‹r
(Po¡.
ü—‹d_d©e
 < 
£lf
.created_date) \

202 .
	$fœ¡
()

203  
´ev_po¡


205 @
ÿched_´İ”ty


206 
def
 
	$Ãxt_po¡
(
£lf
):

207 
Ãxt_po¡
 = 
Po¡
.
qu”y
.
	`f‹r
(Po¡.
ü—‹d_d©e
 > 
£lf
.created_date) \

208 .
	`Üd”_by
('ü—‹d_d©e').
	$fœ¡
()

209  
Ãxt_po¡


211 @
ÿched_´İ”ty


212 
def
 
	$summ¬y
(
£lf
):

213 
s
 = 
»
.
	`fšd®l
(
r
'(<hr>)', 
£lf
.
cÚ‹Á
)

214 
nÙ
 
s
:

215  
£lf
.
cÚ‹Á


216 
p
 = 
s
[0]

217  
	`’dgs
(
£lf
.
cÚ‹Á
.
	`¥l™
(
p
)[0])

219 @
´İ”ty


220 
def
 
	$comm’ts
(
£lf
):

222 
R‘uºs
 
comm’ts
 
š
 
Œ“
. 
Each
 
·»Á
 
comm’t
 
has
 
a
 "comments"

223 
©Œibu‹
 
­³nded
 
ªd
 
a
 "depth"‡ttribute.

225 
comm’ts
 = 
Comm’t
.
qu”y
.
	`f‹r
(Comm’t.
po¡_id
==
£lf
.
id
).
	$®l
()

227 
def
 
	$_g‘_comm’ts
(
·»Á
, 
d•th
):

229 
·»Á
.
comm’ts
 = []

230 
·»Á
.
d•th
 = depth

232 
comm’t
 
š
 
comm’ts
:

233 
comm’t
.
·»Á_id
 =ğ
·»Á
.
id
:

234 
·»Á
.
comm’ts
.
	$­³nd
(
comm’t
)

235 
	`_g‘_comm’ts
(
comm’t
, 
d•th
 + 1)

237 
·»Ás
 = [
c
 ø
š
 
comm’ts
 c.
·»Á_id
 
is
 
NÚe
]

239 
·»Á
 
š
 
·»Ás
:

240 
	$_g‘_comm’ts
(
·»Á
, 0)

242  
·»Ás


244 @
ÿched_´İ”ty


245 
def
 
	$jsÚ
(
£lf
):

246  
	$diù
(
id
=
£lf
.id,

247 
t™Ë
=
£lf
.title,

248 
cÚ‹Á
=
£lf
.content,

249 
authÜ
=
£lf
.authÜ.
u£ºame
)

252 
po¡_gs
 = 
db
.
	`TabË
("po¡_gs", db.
Mod–
.
m‘ad©a
,

253 
db
.
	`CŞumn
("po¡_id", db.
IÁeg”
,

254 
db
.
	`FÜeignKey
('po¡s.id', 
Úd–‘e
='CASCADE'),

255 
´im¬y_key
=
True
),

256 
db
.
	`CŞumn
("g_id", db.
IÁeg”
,

257 
db
.
	`FÜeignKey
('gs.id', 
Úd–‘e
='CASCADE'),

258 
´im¬y_key
=
True
))

261 
şass
 
	$TagQu”y
(
Ba£Qu”y
):

263 @
ÿche
.
	$ÿched
(3600)

264 
def
 
	$şoud
(
£lf
):

266 
gs
 = 
£lf
.
	`f‹r
(
Tag
.
num_po¡s
 > 0).
	$®l
()

268 
nÙ
 
gs
:

271 
max_po¡s
 = 
	$max
(
t
.
num_po¡s
 ˆ
š
 
gs
)

272 
mš_po¡s
 = 
	$mš
(
t
.
num_po¡s
 ˆ
š
 
gs
)

274 
diff
 = (
max_po¡s
 - 
mš_po¡s
) / 10.0

275 
diff
 < 0.1:

276 
diff
 = 0.1

278 
g
 
š
 
gs
:

279 
g
.
size
 = Ñag.
num_po¡s
 / 
diff
)

280 
g
.
size
 < 1:

281 
g
.
size
 = 1

283 
¿ndom
.
	$shufæe
(
gs
)

285  
gs


288 
şass
 
	$Tag
(
db
.
Mod–
):

290 
__bËÇme__
 = "tags"

292 
qu”y_şass
 = 
TagQu”y


294 
id
 = 
db
.
	$CŞumn
(
db
.
IÁeg”
, 
´im¬y_key
=
True
)

295 
¦ug
 = 
db
.
	`CŞumn
(db.
	`Unicode
(80), 
unique
=
True
)

296 
po¡s
 = 
db
.
	$dyÇmic_lßd”
(
Po¡
, 
£cÚd¬y
=
po¡_gs
, 
qu”y_şass
=
Po¡Qu”y
)

298 
_Çme
 = 
db
.
	`CŞumn
("Çme", db.
	`Unicode
(80), 
unique
=
True
)

300 
def
 
	$__š™__
(
£lf
, *
¬gs
, **
kw¬gs
):

301 
	`su³r
(
Tag
, 
£lf
).
	$__š™__
(*
¬gs
, **
kw¬gs
)

303 
def
 
	$__¡r__
(
£lf
):

304  
£lf
.
Çme


306 
def
 
	$__»´__
(
£lf
):

307  "<%s>" % 
£lf


309 
def
 
	$_g‘_Çme
(
£lf
):

310  
£lf
.
_Çme


312 
def
 
	$_£t_Çme
(
£lf
, 
Çme
):

313 
£lf
.
_Çme
 = 
Çme
.
	`low”
().
	$¡r
()

314 
£lf
.
¦ug
 = 
	$¦ugify
(
Çme
)

316 
Çme
 = 
db
.
	`synÚym
("_Çme", 
desütÜ
=
	`´İ”ty
(
_g‘_Çme
, 
_£t_Çme
))

318 @
ÿched_´İ”ty


319 
def
 
	$u¾
(
£lf
):

320  
rou‹
.
	`u¾_fÜ
('g', 
£lf
.
¦ug
)

322 
num_po¡s
 = 
db
.
	`cŞumn_´İ”ty
(

323 
db
.
	`£Ëù
([db.
func
.
	`couÁ
(
po¡_gs
.
c
.
po¡_id
)]).\

324 
	`wh”e
(
db
.
	`ªd_
(
po¡_gs
.
c
.
g_id
==
id
,

325 
Po¡
.
id
==
po¡_gs
.
c
.
po¡_id
)).
	$as_sÿÏr
())

328 
şass
 
	$Comm’tQu”y
(
Ba£Qu”y
):

330 
def
 
	$as_d©a
(
£lf
):

332 
comm’ts
 = [
	`¡Üage
({'authÜ':
comm’t
.
authÜ
,

333 '·»Á':
comm’t
.
·»Á
,

334 'comm’t':
comm’t
.comment,

335 
	}
}è
comm’t
 
š
 
£lf
.
®l
()]

337  
comm’ts


340 
şass
 
	$Comm’t
(
db
.
Mod–
):

342 
__bËÇme__
 = "comments"

344 
qu”y_şass
 = 
Comm’tQu”y


346 
PER_PAGE
 = 40

348 
id
 = 
db
.
	$CŞumn
(
db
.
IÁeg”
, 
´im¬y_key
=
True
)

350 
po¡_id
 = 
db
.
	`CŞumn
(db.
IÁeg”
,

351 
db
.
	`FÜeignKey
(
Po¡
.
id
, 
Úd–‘e
='CASCADE'),

352 
nuÎabË
=
F®£
)

354 
authÜ_id
 = 
db
.
	`CŞumn
(db.
IÁeg”
,

355 
db
.
	`FÜeignKey
(
U£r
.
id
, 
Úd–‘e
='CASCADE'))

357 
·»Á_id
 = 
db
.
	`CŞumn
(db.
IÁeg”
,

358 
db
.
	`FÜeignKey
("comm’ts.id", 
Úd–‘e
='CASCADE'))

360 
ema
 = 
db
.
	`CŞumn
(db.
	$SŒšg
(50))

361 
nickÇme
 = 
db
.
	`CŞumn
(db.
	$Unicode
(50))

362 
webs™e
 = 
db
.
	`CŞumn
(db.
	$SŒšg
(100))

364 
comm’t
 = 
db
.
	$CŞumn
(
db
.
UnicodeText
)

365 
ü—‹d_d©e
 = 
db
.
	$CŞumn
(
db
.
D©eTime
, =
d©‘ime
.
utúow
)

367 

 = 
db
.
	`CŞumn
(db.
	$SŒšg
(20))

369 
_authÜ
 = 
db
.
	`»ÏtiÚ
(
U£r
, 
back»f
="po¡s", 
Ïzy
="joined")

371 
po¡
 = 
db
.
	`»ÏtiÚ
(
Po¡
, 
šÃrjoš
=
True
, 
Ïzy
="joined")

373 
·»Á
 = 
db
.
	`»ÏtiÚ
('Comm’t', 
Ïzy
="jošed", 
»mÙe_side
=[
id
])

375 
__m­³r_¬gs__
 = {'Üd”_by' : 
id
.
	`asc
()
	}
}

378 
şass
 
	$P”missiÚs
(
objeù
):

380 
def
 
	$__š™__
(
£lf
, 
obj
):

381 
£lf
.
obj
 = obj

383 @
ÿched_´İ”ty


384 
def
 
	$ed™
(
£lf
):

385  
	`P”missiÚ
(
	`U£rN“d
(
£lf
.
obj
.
authÜ_id
))

387 @
ÿched_´İ”ty


388 
def
 
	$»¶y
(
£lf
):

389  
	`P”missiÚ
(
	`U£rN“d
(
£lf
.
obj
.
po¡
.
authÜ_id
))

391 @
ÿched_´İ”ty


392 
def
 
	$d–‘e
(
£lf
):

393  
admš
 & 
mod”©Ü


396 
def
 
	$__š™__
(
£lf
, *
¬gs
, **
kw¬gs
):

397 
	`su³r
(
Comm’t
, 
£lf
).
	$__š™__
(*
¬gs
, **
kw¬gs
)

399 
def
 
	$__¡r__
(
£lf
):

400  
£lf
.
comm’t


402 
def
 
	$__»´__
(
£lf
):

403  "<%s>" % 
£lf


405 @
ÿched_´İ”ty


406 
def
 
	$³rmissiÚs
(
£lf
):

407  
£lf
.
	$P”missiÚs
(
£lf
)

409 
def
 
	$_g‘_authÜ
(
£lf
):

410 
£lf
.
_authÜ
:

411 
£lf
.
_authÜ
.
webs™e
 = 
NÚe


412  
£lf
.
_authÜ


413  
	$¡Üage
(
ema
 = 
£lf
.email,

414 
nickÇme
 = 
£lf
.nickname,

415 
webs™e
 = 
£lf
.website)

417 
def
 
	$_£t_authÜ
(
£lf
, 
authÜ
):

418 
£lf
.
_authÜ
 = 
authÜ


420 
authÜ
 = 
db
.
	`synÚym
("_authÜ", 
desütÜ
=
	`´İ”ty
(
_g‘_authÜ
, 
_£t_authÜ
))

422 @
ÿched_´İ”ty


423 
def
 
	$u¾
(
£lf
):

424  "%s#comm’t-%s" % (
£lf
.
po¡
.
u¾
, s–f.
id
)

426 @
ÿched_´İ”ty


427 
def
 
	$m¬kdown
(
£lf
):

428  
	`m¬kdown
(
£lf
.
comm’t
 
Ü
 '')

430 @
ÿched_´İ”ty


431 
def
 
	$jsÚ
(
£lf
):

432  
	`diù
(
id
=
£lf
.id,

433 
authÜ
=
£lf
.author,

434 
u¾
=
£lf
.url,

435 
comm’t
=
£lf
.comment,

436 
ü—‹d_d©e
=
£lf
.created_date)

438 @
ÿched_´İ”ty


439 
def
 
	$™em
(
£lf
):

440  
	$¡Üage
(
£lf
.
jsÚ
)

443 
Po¡
.
num_comm’ts
 = 
db
.
	`cŞumn_´İ”ty
(

444 
db
.
	`£Ëù
([db.
func
.
	`couÁ
(
Comm’t
.
po¡_id
)]) \

445 .
	`wh”e
(
Comm’t
.
po¡_id
==
Po¡
.
id
).
	`as_sÿÏr
(), 
deã¼ed
=
True
)

	@pypress/models/links.py

1 #!/
u¤
/
bš
/
’v
 
pythÚ


2 #codšg=
utf
-8

4 
	gmod–s
: 
lšks
.
py


6 :
authÜ
: 
Ïoqiu
.
com
@
gma
.com

8 
äom
 
d©‘ime
 
impÜt
 datetime

10 
äom
 
py´ess
.
ex‹nsiÚs
.
ÿche
 
impÜt
 
ÿched_´İ”ty


11 
äom
 
py´ess
.
h–³rs
 
impÜt
 
¡Üage


12 
äom
 
py´ess
.
d©aba£
 
impÜt
 
db


15 
__®l__
 = ['Link',]

17 
şass
 
	$Lšk
(
db
.
Mod–
):

19 
__bËÇme__
 = "links"

21 
PER_PAGE
 = 80

23 
id
 = 
db
.
	$CŞumn
(
db
.
IÁeg”
, 
´im¬y_key
=
True
)

24 
Çme
 = 
db
.
	`CŞumn
(db.
	`Unicode
(50), 
nuÎabË
=
F®£
)

25 
lšk
 = 
db
.
	`CŞumn
(db.
	`SŒšg
(100), 
nuÎabË
=
F®£
)

26 
logo
 = 
db
.
	`CŞumn
(db.
	$SŒšg
(100))

27 
desütiÚ
 = 
db
.
	`CŞumn
(db.
	$Unicode
(100))

28 
ema
 = 
db
.
	`CŞumn
(db.
	$SŒšg
(50))

29 
·s£d
 = 
db
.
	$CŞumn
(
db
.
BoŞ—n
, =
F®£
)

30 
ü—‹d_d©e
 = 
db
.
	$CŞumn
(
db
.
D©eTime
, =
d©‘ime
.
utúow
)

32 
şass
 
	$P”missiÚs
(
objeù
):

34 
def
 
	$__š™__
(
£lf
, 
obj
):

35 
£lf
.
obj
 = obj

38 
def
 
	$__š™__
(
£lf
, *
¬gs
, **
kw¬gs
):

39 
	`su³r
(
Lšk
, 
£lf
).
	$__š™__
(*
¬gs
, **
kw¬gs
)

41 
def
 
	$__¡r__
(
£lf
):

42  
£lf
.
Çme


44 
def
 
	$__»´__
(
£lf
):

45  "<%s>" % 
£lf


47 @
ÿched_´İ”ty


48 
def
 
	$³rmissiÚs
(
£lf
):

49  
£lf
.
	`P”missiÚs
(self)

51 @
ÿched_´İ”ty


52 
def
 
	$jsÚ
(
£lf
):

53  
	`diù
(
id
=
£lf
.id,

54 
Çme
=
£lf
.name,

55 
u¾
=
£lf
.
lšk
,

56 
logo
=
£lf
.logo,

57 
desütiÚ
=
£lf
.description,

58 
ü—‹d_d©e
=
£lf
.created_date)

60 @
ÿched_´İ”ty


61 
def
 
	$™em
(
£lf
):

62  
	`¡Üage
(
£lf
.
jsÚ
)

	@pypress/models/types.py

1 #!/
u¤
/
bš
/
’v
 
pythÚ


2 #codšg=
utf
-8

4 
	gty³s
.
	gpy


6 :
liûn£
: 
BSD
, 
£e
 
LICENSE
 
mÜe
 
	gd‘as
.

9 
äom
 
sqÏlchemy
 
impÜt
 
ty³s


11 
şass
 
	$D’Üm®izedText
(
ty³s
.
MubËTy³
,y³s.
Ty³DecÜ©Ü
):

13 
StÜes
 
d’Üm®ized
 
´im¬y
 
keys
 
th©
 
ÿn
 
be


14 
acûs£d
 
as
 
a
 
£t
.

16 :
·¿m
 
cÛrû
: 
cÛrciÚ
 
funùiÚ
 
th©
 
’su»s
 
cÜ»ù


17 
ty³
 
is
 
»tuºed


19 :
·¿m
 
£·¿tÜ
: s•¬©Ü 
ch¬aù”


22 
im¶
 = 
ty³s
.
Text


24 
def
 
	`__š™__
(
£lf
, 
cÛrû
=, 
£·¿tÜ
=" ", **
kw¬gs
):

26 
£lf
.
cÛrû
 = coerce

27 
£lf
.
£·¿tÜ
 = separator

29 
	`su³r
(
D’Üm®izedText
, 
£lf
).
	$__š™__
(**
kw¬gs
)

31 
def
 
	$´oûss_bšd_·¿m
(
£lf
, 
v®ue
, 
dŸËù
):

32 
v®ue
 
is
 
nÙ
 
NÚe
:

33 
™ems
 = [
	`¡r
(
™em
).
	$¡r
(è
™em
 
š
 
v®ue
]

34 
v®ue
 = 
£lf
.
£·¿tÜ
.
	$još
(
™em
 ™em 
š
 
™ems
 item)

35  
v®ue


37 
def
 
	$´oûss_»suÉ_v®ue
(
£lf
, 
v®ue
, 
dŸËù
):

38 
nÙ
 
v®ue
:

39  
	$£t
()

40  
	`£t
(
£lf
.
	`cÛrû
(
™em
) \

41 
™em
 
š
 
v®ue
.
	$¥l™
(
£lf
.
£·¿tÜ
))

43 
def
 
	$cİy_v®ue
(
£lf
, 
v®ue
):

44  
	`£t
(
v®ue
)

	@pypress/models/users.py

1 #!/
u¤
/
bš
/
’v
 
pythÚ


2 #codšg=
utf
-8

4 
	gmod–s
: 
u£rs
.
py


6 :
authÜ
: 
Ïoqiu
.
com
@
gma
.com

9 
impÜt
 
hashlib


10 
äom
 
d©‘ime
 
impÜt
 datetime

12 
impÜt
 
tÜÇdo
.
web


14 
äom
 
py´ess
.
ex‹nsiÚs
.
sqÏlchemy
 
impÜt
 
Ba£Qu”y


15 
äom
 
py´ess
.
ex‹nsiÚs
.
³rmissiÚ
 
impÜt
 
P”missiÚ
, 
	gRŞeN“d
, 
U£rN“d


16 
äom
 
	gpy´ess
.
	gex‹nsiÚs
.
ÿche
 
impÜt
 
ÿched_´İ”ty


17 
äom
 
	gpy´ess
.
³rmissiÚs
 
impÜt
 
admš


18 
äom
 
	gpy´ess
.
d©aba£
 
impÜt
 
db


21 
	g__®l__
 = ['User', 'UserCode', 'Tweet', ]

24 
şass
 
	$U£rQu”y
(
Ba£Qu”y
):

26 
def
 
	$auth’tiÿ‹
(
£lf
, 
logš
, 
·sswÜd
):

28 
u£r
 = 
£lf
.
	`f‹r
(
db
.
	`Ü_
(
U£r
.
u£ºame
==
logš
,

29 
U£r
.
ema
==
logš
)).
	$fœ¡
()

31 
u£r
:

32 
auth’tiÿ‹d
 = 
u£r
.
	$check_·sswÜd
(
·sswÜd
)

34 
auth’tiÿ‹d
 = 
F®£


36  
u£r
, 
auth’tiÿ‹d


38 
def
 
	$£¬ch
(
£lf
, 
key
):

39 
qu”y
 = 
£lf
.
	`f‹r
(
db
.
	`Ü_
(
U£r
.
ema
==
key
,

40 
U£r
.
nickÇme
.
	`ike
('%'+
key
+'%'),

41 
U£r
.
u£ºame
.
	`ike
('%'+
key
+'%')))

42  
qu”y


44 
def
 
	$g‘_by_u£ºame
(
£lf
, 
u£ºame
):

45 
u£r
 = 
£lf
.
	`f‹r
(
U£r
.
u£ºame
==u£ºame).
	$fœ¡
()

46 
u£r
 
is
 
NÚe
:

47 
¿i£
 
tÜÇdo
.
web
.
	$HTTPE¼Ü
(404)

48  
u£r


51 
şass
 
	$U£r
(
db
.
Mod–
):

53 
__bËÇme__
 = 'users'

55 
qu”y_şass
 = 
U£rQu”y


57 
PER_PAGE
 = 50

58 
TWEET_PER_PAGE
 = 30

60 
MEMBER
 = 100

61 
MODERATOR
 = 200

62 
ADMIN
 = 300

64 
id
 = 
db
.
	$CŞumn
(
db
.
IÁeg”
, 
´im¬y_key
=
True
)

65 
u£ºame
 = 
db
.
	`CŞumn
(db.
	`SŒšg
(20), 
unique
=
True
)

66 
nickÇme
 = 
db
.
	`CŞumn
(db.
	$SŒšg
(20))

67 
ema
 = 
db
.
	`CŞumn
(db.
	`SŒšg
(100), 
unique
=
True
, 
nuÎabË
=
F®£
)

68 
_·sswÜd
 = 
db
.
	`CŞumn
("·sswÜd", db.
	`SŒšg
(80), 
nuÎabË
=
F®£
)

69 
rŞe
 = 
db
.
	$CŞumn
(
db
.
IÁeg”
, =
MEMBER
)

70 
aùiv©iÚ_key
 = 
db
.
	`CŞumn
(db.
	$SŒšg
(40))

71 
d©e_jošed
 = 
db
.
	$CŞumn
(
db
.
D©eTime
, =
d©‘ime
.
utúow
)

72 
Ï¡_logš
 = 
db
.
	$CŞumn
(
db
.
D©eTime
, =
d©‘ime
.
utúow
)

73 
block
 = 
db
.
	$CŞumn
(
db
.
BoŞ—n
, =
F®£
)

75 
şass
 
	$P”missiÚs
(
objeù
):

77 
def
 
	$__š™__
(
£lf
, 
obj
):

78 
£lf
.
obj
 = obj

80 @
ÿched_´İ”ty


81 
def
 
	$ed™
(
£lf
):

82  
	`P”missiÚ
(
	`U£rN“d
(
£lf
.
obj
.
id
)è& 
admš


85 
def
 
	$__š™__
(
£lf
, *
¬gs
, **
kw¬gs
):

86 
	`su³r
(
U£r
, 
£lf
).
	$__š™__
(*
¬gs
, **
kw¬gs
)

88 
def
 
	$__¡r__
(
£lf
):

89  "U£r: %s" % 
£lf
.
nickÇme


91 
def
 
	$__»´__
(
£lf
):

92  "<%s>" % 
£lf


94 @
ÿched_´İ”ty


95 
def
 
	$³rmissiÚs
(
£lf
):

96  
£lf
.
	`P”missiÚs
(self)

98 @
ÿched_´İ”ty


99 
def
 
	$´ovides
(
£lf
):

100 
Ãeds
 = [
	`RŞeN“d
('authenticated'),

101 
	`U£rN“d
(
£lf
.
id
)]

103 
£lf
.
is_mod”©Ü
:

104 
Ãeds
.
	`­³nd
(
	`RŞeN“d
('moderator'))

106 
£lf
.
is_admš
:

107 
Ãeds
.
	`­³nd
(
	`RŞeN“d
('admin'))

109  
Ãeds


111 
def
 
	$_g‘_·sswÜd
(
£lf
):

112  
£lf
.
_·sswÜd


114 
def
 
	$_£t_·sswÜd
(
£lf
, 
·sswÜd
):

115 
£lf
.
_·sswÜd
 = 
hashlib
.
	`md5
(
·sswÜd
).
	$hexdige¡
()

117 
·sswÜd
 = 
db
.
	`synÚym
("_password",

118 
desütÜ
=
	$´İ”ty
(
_g‘_·sswÜd
,

119 
_£t_·sswÜd
))

121 
def
 
	$check_·sswÜd
(
£lf
,
·sswÜd
):

122 
£lf
.
·sswÜd
 
is
 
NÚe
:

123  
F®£


124  
£lf
.
·sswÜd
 =ğ
hashlib
.
	`md5
ÕasswÜd).
	`hexdige¡
()

126 @
´İ”ty


127 
def
 
	$is_mod”©Ü
(
£lf
):

128  
£lf
.
rŞe
 >ğ£lf.
MODERATOR


130 @
´İ”ty


131 
def
 
	$is_admš
(
£lf
):

132  
£lf
.
rŞe
 >ğ£lf.
ADMIN


134 @
´İ”ty


135 
def
 
	$jsÚ
(
£lf
):

136  
	$diù
(
id
=
£lf
.id,

137 
u£ºame
=
£lf
.username,

138 
nickÇme
=
£lf
.nickname,

139 
ema
=
£lf
.email,

140 
is_admš
=
£lf
.is_admin,

141 
is_mod”©Ü
=
£lf
.is_moderator,

142 
Ï¡_logš
=
£lf
.last_login)

145 
şass
 
	$U£rCode
(
db
.
Mod–
):

147 
__bËÇme__
 = 'usercode'

149 
id
 = 
db
.
	$CŞumn
(
db
.
IÁeg”
, 
´im¬y_key
=
True
)

150 
code
 = 
db
.
	`CŞumn
(db.
	`SŒšg
(20), 
nuÎabË
=
F®£
)

151 
rŞe
 = 
db
.
	$CŞumn
(
db
.
IÁeg”
, =
U£r
.
MEMBER
)

153 
def
 
	$__š™__
(
£lf
, *
¬gs
, **
kw¬gs
):

154 
	`su³r
(
U£rCode
, 
£lf
).
	$__š™__
(*
¬gs
, **
kw¬gs
)

156 
def
 
	$__¡r__
(
£lf
):

157  
£lf
.
code


159 
def
 
	$__»´__
(
£lf
):

160  "<%s>" % 
£lf


163 
şass
 
	$Tw“t
(
db
.
Mod–
):

165 
__bËÇme__
 = 'tweets'

167 
id
 = 
db
.
	$CŞumn
(
db
.
IÁeg”
, 
´im¬y_key
=
True
)

169 
u£r_id
 = 
db
.
	`CŞumn
(db.
IÁeg”
,

170 
db
.
	`FÜeignKey
(
U£r
.
id
, 
Úd–‘e
='CASCADE'),

171 
nuÎabË
=
F®£
,

172 
unique
=
True
)

174 
£rv”
 = 
db
.
	`CŞumn
(db.
	$SŒšg
(50))

175 
tok’
 = 
db
.
	`CŞumn
(db.
	$SŒšg
(50))

176 
tok’_£ü‘
 = 
db
.
	`CŞumn
(db.
	$SŒšg
(50))

178 
def
 
	$__š™__
(
£lf
, *
¬gs
, **
kw¬gs
):

179 
	`su³r
(
Tw“t
, 
£lf
).
	$__š™__
(*
¬gs
, **
kw¬gs
)

181 
def
 
	$__¡r__
(
£lf
):

182  "Tw“t: %s" % 
£lf
.
id


184 
def
 
	$__»´__
(
£lf
):

185  "<%s>" % 
£lf


188 
U£r
.
tw“ts
 = 
db
.
	`»ÏtiÚ
(
Tw“t
, 
back»f
="user")

191 
U£r
.
weibo
 = 
NÚe


192 
U£r
.
doubª
 = 
NÚe


193 
U£r
.
qq
 = 
NÚe


	@pypress/permissions.py

1 #! /
u¤
/
bš
/
’v
 
pythÚ


2 #codšg=
utf
-8

4 
	g³rmissiÚs
.
	gpy


6 
£t
 
rŞe
 
Ãed
 
	g³rmissiÚs


7 :
authÜ
: 
Ïoqiu
.
com
@
gma
.com

10 
äom
 
ex‹nsiÚs
.
³rmissiÚ
 
impÜt
 
RŞeN“d
, 
P”missiÚ


12 
	gadmš
 = 
P”missiÚ
(
RŞeN“d
('admin'))

13 
mod”©Ü
 = 
P”missiÚ
(
RŞeN“d
('moderator'))

14 
auth
 = 
P”missiÚ
(
RŞeN“d
('authenticated'))

	@pypress/settings.py

1 #!/
u¤
/
bš
/
’v
 
pythÚ


2 #codšg=
utf
-8

3 
impÜt
 
os


5 
	gDEBUG
 = 
True


6 
COOKIE_SECRET
 = 'simple'

7 
LOGIN_URL
 = '/login'

8 
XSRF_COOKIES
 = 
True


9 
THEME_NAME
 = 'simple'

11 #deçuÉ 
‹m¶©es
 
ªd
 
·th
 
£‰šgs


12 
TEMPLATE_PATH
 = 
os
.
·th
.
još
(os.·th.
dœÇme
(
__fe__
), 'templates')

13 
	gSTATIC_PATH
 = 
os
.
·th
.
još
(os.·th.
dœÇme
(
__fe__
), 'static')

15 #them
·th
 
£‰šgs


16 
	gTHEME_PATH
 = 
os
.
·th
.
još
(os.·th.
dœÇme
(
__fe__
), 'themes', 
THEME_NAME
)

17 
	gTHEME_TEMPLATE_PATH
 = 
os
.
·th
.
još
(
THEME_PATH
, 'templates')

18 
	gTHEME_STATIC_PATH
 = 
os
.
·th
.
još
(
THEME_PATH
, 'static')

20 
	gUPLOAD_PATH
 = 
os
.
·th
.
još
(os.·th.
dœÇme
(
__fe__
), 'uploads')

22 
	gDEFAULT_LOCALE
 = '’_US' #'
zh_CN
'

24 #REDIS_SERVER = 
F®£


26 #Ià
£t
 
to
 
NÚe
 
Ü
 0 
the
 
£ssiÚ
 
wl
 
be
 
d–‘ed
 
wh’
h
u£r
 
şo£s
h
brow£r
.

27 #Ià
£t
 
numb”
 
the
 
£ssiÚ
 
lives
 
v®ue
 
days
.

28 
PERMANENT_SESSION_LIFETIME
 = 1 #days

30 #»di 
cÚÃùiÚ
 
cÚfig


31 
REDIS_HOST
 = 'localhost'

32 
REDIS_PORT
 = 6379

33 
REDIS_DB
 = 0

35 
Œy
:

36 
äom
 
loÿl_£‰šgs
 
impÜt
 *

37 
exû±
:

38 
·ss


	@pypress/uimodules.py

1 #!/
u¤
/
bš
/
’v
 
pythÚ


2 #codšg=
utf
-8

4 
impÜt
 
	gtÜÇdo
.
web


6 
şass
 
	$Po¡
(
tÜÇdo
.
web
.
UIModuË
):

7 
def
 
	$»nd”
(
£lf
, 
po¡
, 
show_comm’ts
=
F®£
):

8  
£lf
.
	`»nd”_¡ršg
(

9 "blog/moduË-po¡.html", 
po¡
õo¡, 
show_comm’ts
=show_comments)

11 
şass
 
	$Li¡
(
tÜÇdo
.
web
.
UIModuË
):

12 
def
 
	$»nd”
(
£lf
, 
·ge_obj
, 
·ge_u¾
, *
¬gs
):

13  
£lf
.
	`»nd”_¡ršg
(

14 "blog/moduË-li¡.html", 
·ge_obj
õage_obj, 
·ge_u¾
õage_u¾, *
¬gs
)

16 
şass
 
	$Comm’t
(
tÜÇdo
.
web
.
UIModuË
):

17 
def
 
	$»nd”
(
£lf
, 
comm’t
, 
fÜm
):

18  
£lf
.
	`»nd”_¡ršg
("blog/moduË-comm’t.html", 
comm’t
=comm’t, 
fÜm
=form)

20 
şass
 
	$Pagš©e
(
tÜÇdo
.
web
.
UIModuË
):

21 
def
 
	$»nd”
(
£lf
, 
·ge_obj
, 
·ge_u¾
, *
¬gs
):

22  
£lf
.
	`»nd”_¡ršg
(

23 "maüos/_·ge.html", 
·ge_obj
õage_obj, 
·ge_u¾
õage_u¾, *
¬gs
)

	@pypress/utils/__init__.py

1 #!/
u¤
/
bš
/
’v
 
pythÚ


	@pypress/utils/imagelib.py

1 #! /
u¤
/
bš
/
’v
 
pythÚ


2 #codšg=
utf
-8

4 
	gimageProûss
.
	gpy


6 
Reÿ±cha
 
ªd
 
	gThumbÇ


8 :
cİyright
: (
c
è2010 
by
 
Laoqiu
.

9 :
liûn£
: 
BSD
, 
£e
 
LICENSE
 
mÜe
 
	gd‘as
.

12 
impÜt
 
os


13 
impÜt
 
¿ndom


14 
impÜt
 
	gImage
, 
	gImageFÚt
, 
	gImageD¿w
, 
ImageEnhªû


15 
impÜt
 
SŒšgIO


17 
def
 
	$Reÿ±cha
(
‹xt
):

18 
img
 = 
Image
.
	`Ãw
('RGB',
size
=(110,26),
cŞÜ
=(255,255,255))

20 #£ˆ
fÚt


21 
fÚt
 = 
ImageFÚt
.
	`Œu‘y³
(
os
.
·th
.
	`još
(os.·th.
	`dœÇme
(
__fe__
),'FacesAndCaps.ttf'),25)

22 
d¿w
 = 
ImageD¿w
.
	$D¿w
(
img
)

23 
cŞÜs
 = [(250,125,30),(15,65,150),(210,30,90),(64,25,90),(10,120,40),(95,0,16)]

25 #wr™
‹xt


26 
i
,
s
 
š
 
	$’um”©e
(
‹xt
):

27 
pos™iÚ
 = (
i
*25+4,0)

28 
d¿w
.
	`‹xt
(
pos™iÚ
, 
s
, 
fl
=
¿ndom
.
	`choiû
(
cŞÜs
),
fÚt
=font)

30 #£ˆ
bÜd”


31 #d¿w.
	`lše
([(0,0),(99,0),(99,29),(0,29),(0,0)], 
fl
=(180,180,180))

32 
d–
 
d¿w


34 #push 
d©a


35 
¡rIO
 = 
SŒšgIO
.
	$SŒšgIO
()

36 
img
.
	`§ve
(
¡rIO
,'PNG')

37 
¡rIO
.
	$£ek
(0)

38  
¡rIO


40 
def
 
	$»duû_İac™y
(
im
, 
İac™y
):

42 
as£¹
 
İac™y
 >ğ0 
ªd
 opacity <= 1

43 
im
.
mode
 != 'RGBA':

44 
im
 = im.
	`cÚv”t
('RGBA')

46 
im
 = im.
	$cİy
()

47 
®pha
 = 
im
.
	`¥l™
()[3]

48 
®pha
 = 
ImageEnhªû
.
	`BrighŠess
×Íha).
	$’hªû
(
İac™y
)

49 
im
.
	$puÍha
(
®pha
)

50  
im


52 
şass
 
	$ThumbÇ
(
objeù
):

54 
t
 = 
	$ThumbÇ
(
·th
)

55 
t
.
	`thumb
(
size
=(100,100),
outfe
='fe/to/Çme.xx',
bg
=
F®£
,
w©”m¬k
=
NÚe
)

57 
def
 
	$__š™__
(
£lf
, 
·th
):

58 
£lf
.
·th
 =…ath

59 
Œy
:

60 
£lf
.
img
 = 
Image
.
	$İ’
(
£lf
.
·th
)

61 
exû±
 
IOE¼Ü
:

62 
£lf
.
img
 = 
NÚe


63 
¿i£
 "% nÙ images" % 
·th


65 
def
 
	`thumb
(
£lf
, 
size
=(100,100), 
outfe
=
NÚe
, 
fËr
=
F®£
, 
w©”m¬k
=None):

67 
outfe
: 'file/to/outfile.xxx'

68 
fËr
: 
True
|
F®£


69 
w©”m¬k
: 'file/to/watermark.xxx'

71 
nÙ
 
£lf
.
img
:

72 
´št
 'must be have‡ imageo…rocess'

75 
nÙ
 
outfe
:

76 
outfe
 = 
£lf
.
·th


79 
·¹
 = 
£lf
.
img


80 
·¹
.
	$thumbÇ
(
size
, 
Image
.
ANTIALIAS
) #æŒ‰æ¯”ä¾‹ç¼©ç•¥

82 
size
 = siz
fËr
 
·¹
.size #ä¸è¡¥ç™½åˆ™æ­£å¸¸ç¼©æ”¾

83 
w
,
h
 = 
size


85 
Ïy”
 = 
Image
.
	`Ãw
('RGBA',
size
,(255,255,255)) #ç™½è‰²åº•å›¾

88 
pw
,
ph
 = 
·¹
.
size


89 
Ëá
 = (
h
-
ph
)/2

90 
uµ”
 = (
w
-
pw
)/2

91 
Ïy”
.
	`·¡e
(
·¹
,(
uµ”
,
Ëá
)) #ç²˜è´´åŸå›¾

93 #å¦‚æœæœ‰
w©”m¬k
å‚æ•°åˆ™åŠ æ°´å°

94 
w©”m¬k
:

95 
·¹
 = 
Image
.
	$İ’
(
w©”m¬k
)

96 
·¹
 = 
	$»duû_İac™y
(
·¹
, 0.3)

98 
lw
,
lh
 = 
·¹
.
size


99 
pos™iÚ
 = (
w
-
lw
,
h
-
lh
)

100 
Ïy”
.
mode
 != 'RGBA':

101 
Ïy”
.
	`cÚv”t
('RGBA')

102 
m¬k
 = 
Image
.
	`Ãw
('RGBA', 
Ïy”
.
size
, (0,0,0,0))

103 
m¬k
.
	$·¡e
(
·¹
, 
pos™iÚ
)

104 
Ïy”
 = 
Image
.
	$compos™e
(
m¬k
, 
Ïy”
, mark)

106 
Ïy”
.
	$§ve
(
outfe
, 
qu®™y
=100) #ä¿å­˜

107  
outfe


110 
__Çme__
=='__main__':

111 
t
 = 
	`ThumbÇ
('pic.jpg')

112 
t
.
	`thumb
()

	@pypress/views/__init__.py

1 #!/
u¤
/
bš
/
’v
 
pythÚ


2 
	gäom
 .
ba£
 
impÜt
 
	gE¼ÜHªdËr
, 
	gReque¡HªdËr


	@pypress/views/account.py

1 #!/
u¤
/
bš
/
’v
 
pythÚ


2 #codšg=
utf
-8

4 
	gv›ws
: 
accouÁ
.
py


6 :
authÜ
: 
Ïoqiu
.
com
@
gma
.com

8 
äom
 
d©‘ime
 
impÜt
 datetime

9 
impÜt
 
cPickË
 
as
 
pickË


11 
äom
 
py´ess
.
v›ws
 
impÜt
 
Reque¡HªdËr


12 
äom
 
py´ess
.
d©aba£
 
impÜt
 
db


13 
äom
 
py´ess
.
mod–s
 
impÜt
 
U£r
, 
U£rCode


14 
äom
 
	gpy´ess
.
	gex‹nsiÚs
.
routšg
 
impÜt
 
	grou‹


16 @
rou‹
(
r
'/logš', 
Çme
='login')

17 
şass
 
	$Logš
(
Reque¡HªdËr
):

18 
def
 
	$g‘
(
£lf
):

20 
fÜm
 = 
£lf
.
fÜms
.
	`LogšFÜm
(
Ãxt
=£lf.
	`g‘_¬gs
('next'))

22 
£lf
.
	`»nd”
('accouÁ/logš.html', 
fÜm
=form)

25 
def
 
	$po¡
(
£lf
):

27 
fÜm
 = 
£lf
.
fÜms
.
	$LogšFÜm
(
£lf
.
»que¡
.
¬gum’ts
)

29 
fÜm
.
	$v®id©e
():

30 
u£r
, 
auth’tiÿ‹d
 = 
U£r
.
qu”y
.
	`auth’tiÿ‹
(
£lf
.
	`g‘_¬gs
('login',''),

31 
£lf
.
	`g‘_¬gs
('password',''))

32 
u£r
 
ªd
 
auth’tiÿ‹d
:

34 
u£r
.
Ï¡_logš
 = 
d©‘ime
.
	$utúow
() #utcnow

35 
db
.
£ssiÚ
.
	$comm™
()

37 #£ˆ
cook›


38 
£lf
.
£ssiÚ
['u£r'] = 
u£r


39 #£lf.
£ssiÚ
.
	`£t_expœes
(
days
=2)

40 
£lf
.
£ssiÚ
.
	$§ve
()

43 
£lf
.
	`æash
(£lf.
	`_
("W–comback, %s" % 
u£r
.
u£ºame
), "success")

46 
Ãxt_u¾
 = 
fÜm
.
Ãxt
.
d©a


47 
nÙ
 
Ãxt_u¾
:

48 
Ãxt_u¾
 = '/'

49 
£lf
.
	$»dœeù
(
Ãxt_u¾
)

52 
fÜm
.
subm™
.
”rÜs
.
	`­³nd
(
£lf
.
	`_
("The username or…assword you…rovided‡re incorrect."))

54 
£lf
.
	`»nd”
('accouÁ/logš.html', 
fÜm
=form)

58 @
	`rou‹
(
r
'/logout', 
Çme
='logout')

59 
şass
 
	$Logout
(
Reque¡HªdËr
):

60 
def
 
	$g‘
(
£lf
):

62 
d–
 
£lf
.
£ssiÚ
["user"]

63 
£lf
.
£ssiÚ
.
	$§ve
()

66 
Ãxt_u¾
 = 
£lf
.
	`g‘_¬gs
('next')

67 
nÙ
 
Ãxt_u¾
:

68 
Ãxt_u¾
 = '/'

69 
£lf
.
	$»dœeù
(
Ãxt_u¾
)

73 @
	`rou‹
(
r
'/signup', 
Çme
='signup')

74 
şass
 
	$Signup
(
Reque¡HªdËr
):

75 
def
 
	$g‘
(
£lf
):

77 
fÜm
 = 
£lf
.
fÜms
.
	`SignupFÜm
(
Ãxt
=£lf.
	`g‘_¬gs
('next'))

79 
£lf
.
	`»nd”
("accouÁ/signup.html", 
fÜm
=form)

82 
def
 
	$po¡
(
£lf
):

84 
fÜm
 = 
£lf
.
fÜms
.
	$SignupFÜm
(
£lf
.
»que¡
.
¬gum’ts
)

86 
fÜm
.
	$v®id©e
():

88 
code
 = 
U£rCode
.
qu”y
.
	`f‹r_by
(code=
fÜm
.code.
d©a
).
	$fœ¡
()

90 
code
:

91 
u£r
 = 
	$U£r
(
rŞe
=
code
.role)

92 
fÜm
.
	$pİuÏ‹_obj
(
u£r
)

94 
db
.
£ssiÚ
.
	$add
(
u£r
)

95 
db
.
£ssiÚ
.
	$d–‘e
(
code
)

96 
db
.
£ssiÚ
.
	$comm™
()

98 
£lf
.
£ssiÚ
['u£r'] = 
u£r


100 
Ãxt_u¾
 = 
fÜm
.
Ãxt
.
d©a


102 
nÙ
 
Ãxt_u¾
:

103 
Ãxt_u¾
 = 
£lf
.
	`»v”£_u¾
('³İË', 
u£r
.
u£ºame
)

105  
£lf
.
	$»dœeù
(
Ãxt_u¾
)

107 
fÜm
.
code
.
”rÜs
.
	`­³nd
(
£lf
.
	`_
("Code is‚ot‡llowed"))

109 
£lf
.
	`»nd”
("accouÁ/signup.html", 
fÜm
=form)

113 @
	`rou‹
(
r
'/i18n', 
Çme
='language')

114 
şass
 
	$Lªguage
(
Reque¡HªdËr
):

115 
def
 
	$g‘
(
£lf
):

116 
code
 = 
£lf
.
	`g‘_¬gs
('lang','en_US')

117 
£lf
.
	`£t_cook›
('Ïng', 
code
)

119 
Ãxt_u¾
 = 
£lf
.
	`g‘_¬gs
('next','/')

120 
£lf
.
	$»dœeù
(
Ãxt_u¾
)

	@pypress/views/base.py

1 #!/
u¤
/
bš
/
’v
 
pythÚ


2 #codšg=
utf
-8

4 
	gv›ws
: 
ba£
.
py


6 :
authÜ
: 
Ïoqiu
.
com
@
gma
.com

8 
impÜt
 
os


10 
impÜt
 
loggšg


11 
impÜt
 
tÜÇdo
.
web


12 
impÜt
 
tÜÇdo
.
loÿË


13 
impÜt
 
tÜÇdo
.
esÿ³


14 
impÜt
 
tÜÇdo
.
iŞoİ


16 
äom
 
pygm’ts
 
impÜt
 
highlight


17 
äom
 
pygm’ts
.
Ëx”s
 
impÜt
 
g‘_Ëx”_fÜ_f’ame


18 
äom
 
pygm’ts
.
fÜm©‹rs
 
impÜt
 
HtmlFÜm©‹r


20 
äom
 
py´ess
.
d©aba£
 
impÜt
 
db


21 
äom
 
py´ess
.
mod–s
 
impÜt
 
Comm’t
, 
	gTag
, 
Lšk


22 
äom
 
	gpy´ess
.
	gex‹nsiÚs
.
³rmissiÚ
 
impÜt
 
	gId’t™y
, 
AnÚymousId’t™y


23 
äom
 
	gpy´ess
.
	gex‹nsiÚs
.
ÿche
 
impÜt
 cache

24 
äom
 
	gpy´ess
.
	gex‹nsiÚs
.
£ssiÚs
 
impÜt
 
	gRedisSessiÚ
, 
SessiÚ


27 
şass
 
	$FÏshMes§geMixIn
(
objeù
):

29 
StÜe
 
a
 
mes§ge
 
b‘w“n
 
»que¡s
 
which
 
the
 
u£r
 
Ãeds
 
to
 
£e
.

31 
v›ws


34 
£lf
.
	`æash
("W–comback, %s" % 
u£ºame
, 'success')

36 
ba£
.
html


39 {% 
£t
 
mes§ges
 = 
hªdËr
.
	`g‘_æashed_mes§ges
() %}

40 {% 
mes§ges
 %}

41 <
div
 
id
="flashed">

42 {% 
ÿ‹gÜy
, 
msg
 
š
 
mes§ges
 %}

43 <
¥ª
 
şass
="æash-{{ c©egÜy }}">{{ 
msg
 }}</span>

44 {% 
’d
 %}

45 </
div
>

46 {% 
’d
 %}

48 
def
 
	`æash
(
£lf
, 
mes§ge
, 
ÿ‹gÜy
='message'):

49 
mes§ges
 = 
£lf
.
	`mes§ges
()

50 
mes§ges
.
	`­³nd
((
ÿ‹gÜy
, 
mes§ge
))

51 
£lf
.
	`£t_£cu»_cook›
('æash_mes§ges', 
tÜÇdo
.
esÿ³
.
	`jsÚ_’code
(
mes§ges
))

53 
def
 
	`mes§ges
(
£lf
):

54 
mes§ges
 = 
£lf
.
	`g‘_£cu»_cook›
('flash_messages')

55 
mes§ges
 = 
tÜÇdo
.
esÿ³
.
	`jsÚ_decode
(messages) messages []

56  
mes§ges


58 
def
 
	`g‘_æashed_mes§ges
(
£lf
):

59 
mes§ges
 = 
£lf
.
	`mes§ges
()

60 
£lf
.
	`ş—r_cook›
('flash_messages')

61  
mes§ges


64 
şass
 
	`P”missiÚMixIn
(
objeù
):

65 @
´İ”ty


66 
def
 
	`id’t™y
(
£lf
):

67 
nÙ
 
	`ha§‰r
(
£lf
, "_identity"):

68 
£lf
.
_id’t™y
 = s–f.
	`g‘_id’t™y
()

69  
£lf
.
_id’t™y


71 
def
 
	`g‘_id’t™y
(
£lf
):

72 
£lf
.
cu¼’t_u£r
:

73 
id’t™y
 = 
	`Id’t™y
(
£lf
.
cu¼’t_u£r
.
id
)

74 
id’t™y
.
´ovides
.
	`upd©e
(
£lf
.
cu¼’t_u£r
.provides)

75  
id’t™y


76  
	`AnÚymousId’t™y
()

79 
şass
 
	`CachedI‹msMixIn
(
objeù
):

80 
def
 
	`g‘_ÿched_™ems
(
£lf
, 
Çme
):

81 
™ems
 = 
ÿche
.
	`g‘
(
Çme
)

82 
™ems
 
is
 
NÚe
:

83 
™ems
 = 
£lf
.
	`£t_ÿched_™ems
(
Çme
)

84  
™ems


86 
def
 
	`£t_ÿched_™ems
(
£lf
, 
Çme
, 
lim™
=10):

87 
™ems
 = []

88 
Çme
 == 'latest_comments':

89 
™ems
 = [
comm’t
.
™em
 comm’ˆ
š
 
Comm’t
.
qu”y
.
	`Üd”_by
(Comm’t.
ü—‹d_d©e
.
	`desc
()).
	`lim™
(
lim™
)]

90 
–if
 
Çme
 == 'tags':

91 
™ems
 = 
Tag
.
qu”y
.
	`şoud
()

92 
–if
 
Çme
 == 'links':

93 
™ems
 = [
lšk
.
™em
 lšk 
š
 
Lšk
.
qu”y
.
	`f‹r
(Lšk.
·s£d
==
True
).
	`lim™
(
lim™
)]

94 
ÿche
.
	`£t
(
Çme
, 
™ems
)

95  
™ems


98 
şass
 
	`Reque¡HªdËr
(
tÜÇdo
.
web
.
Reque¡HªdËr
, 
P”missiÚMixIn
, 
FÏshMes§geMixIn
, 
CachedI‹msMixIn
):

99 
def
 
	`Ú_fšish
(
£lf
):

101 
fixed
 
sqÏlchemy
 
”rÜ
: 'Cª'
t
 
»cÚÃù
 
uÁ
 
šv®id
'.‚ew in version 2.2"""

102 
db
.
£ssiÚ
.
	`»move
()

104 
def
 
	`g‘_cu¼’t_u£r
(
£lf
):

105 
u£r
 = 
£lf
.
£ssiÚ
['u£r'] 'u£r' 
š
 s–f.£ssiÚ 
NÚe


106  
u£r


108 @
´İ”ty


109 
def
 
	`£ssiÚ
(
£lf
):

110 
	`ha§‰r
(
£lf
, '_session'):

111  
£lf
.
_£ssiÚ


113 
£lf
.
	`»quœe_£‰šg
('permanent_session_lifetime', 'session')

114 
expœes
 = 
£lf
.
£‰šgs
['³rmª’t_£ssiÚ_liãtime'] 
Ü
 
NÚe


115 '»dis_£rv”' 
š
 
£lf
.
£‰šgs
 
ªd
 self.settings['redis_server']:

116 
£ssiÚid
 = 
£lf
.
	`g‘_£cu»_cook›
('sid')

117 
£lf
.
_£ssiÚ
 = 
	`RedisSessiÚ
(£lf.
­¶iÿtiÚ
.
£ssiÚ_¡Üe
, 
£ssiÚid
, 
expœes_days
=
expœes
)

118 
nÙ
 
£ssiÚid
:

119 
£lf
.
	`£t_£cu»_cook›
('sid', s–f.
_£ssiÚ
.
id
, 
expœes_days
=
expœes
)

121 
£lf
.
_£ssiÚ
 = 
	`SessiÚ
(£lf.
g‘_£cu»_cook›
, s–f.
£t_£cu»_cook›
, 
expœes_days
=
expœes
)

122  
£lf
.
_£ssiÚ


124 
def
 
	`g‘_u£r_loÿË
(
£lf
):

125 
code
 = 
£lf
.
	`g‘_cook›
('Ïng', s–f.
£‰šgs
.
	`g‘
('default_locale', 'zh_CN'))

126  
tÜÇdo
.
loÿË
.
	`g‘
(
code
)

128 
def
 
	`g‘_‹m¶©e_·th
(
£lf
):

129 'theme_‹m¶©e_·th' 
š
 
£lf
.
£‰šgs
:

130  
£lf
.
£‰šgs
['theme_template_path']

131  
£lf
.
£‰šgs
.
	`g‘
('template_path')

133 
def
 
	`g‘_”rÜ_html
(
£lf
, 
¡©us_code
, **
kw¬gs
):

134 
£lf
.
£‰šgs
.
	`g‘
('debug', 
F®£
è
is
 False:

135 
£lf
.
	`£t_¡©us
(
¡©us_code
)

136  
£lf
.
	`»nd”_¡ršg
('”rÜs/%s.html' % 
¡©us_code
)

139 
def
 
	`g‘_¢³t
(
å
, 
rg‘_lše
, 
num_lšes
):

140 
å
.
	`’dsw™h
('.html'):

141 
å
 = 
os
.
·th
.
	`još
(
£lf
.
	`g‘_‹m¶©e_·th
(), fp)

143 
h®f_lšes
 = (
num_lšes
/2)

144 
Œy
:

145 
w™h
 
	`İ’
(
å
è
as
 
f
:

146 
®l_lšes
 = [
lše
 lš
š
 
f
]

147 
code
 = ''.
	`još
(
®l_lšes
[
rg‘_lše
-
h®f_lšes
-1:target_line+half_lines])

148 
fÜm©‹r
 = 
	`HtmlFÜm©‹r
(
lš’os
=
True
, 
lš’o¡¬t
=
rg‘_lše
-
h®f_lšes
, 
hl_lšes
=[half_lines+1])

149 
Ëx”
 = 
	`g‘_Ëx”_fÜ_f’ame
(
å
)

150  
	`highlight
(
code
, 
Ëx”
, 
fÜm©‹r
)

152 
exû±
 
Exû±iÚ
, 
ex
:

153 
loggšg
.
	`”rÜ
(
ex
)

156 
css
 = 
	`HtmlFÜm©‹r
().
	`g‘_¡yË_defs
('.highlight')

157 
exû±iÚ
 = 
kw¬gs
.
	`g‘
('exû±iÚ', 
NÚe
)

158  
£lf
.
	`»nd”_¡ršg
('errors/exception.htm',

159 
g‘_¢³t
=get_snippet,

160 
css
=css,

161 
exû±iÚ
=exception,

162 
¡©us_code
=status_code,

163 
kw¬gs
=kwargs)

165 
def
 
	`g‘_¬gs
(
£lf
, 
key
, =
NÚe
, 
ty³
=None):

166 
ty³
==
li¡
:

167  
is
 
NÚe
:  = []

168  
£lf
.
	`g‘_¬gum’ts
(
key
, )

169 
v®ue
 = 
£lf
.
	`g‘_¬gum’t
(
key
, )

170 
v®ue
 
ªd
 
ty³
:

171 
Œy
:

172 
v®ue
 = 
	`ty³
(value)

173 
exû±
 
V®ueE¼Ü
:

174 
v®ue
 = 

175  
v®ue


177 @
´İ”ty


178 
def
 
	`is_xhr
(
£lf
):

180 
This
 
Úly
 
wÜks
 
w™h
 
lib¿r›s
 
th©
 
suµÜt
 
the
 `
X
-
Reque¡ed
-
W™h
`

181 
h—d”
 
ªd
 
£t
 
™
 
to
 "XMLH‰pReque¡". 
Lib¿r›s
 
th©
 dØth© 
¬e


182 
´ÙÙy³
, 
jQu”y
 
ªd
 
Mochik™
‡nd 
´obably
 
some
 
mÜe
.'''

183  
£lf
.
»que¡
.
h—d”s
.
	`g‘
('X-Requested-With', '') \

184 .
	`low”
() == 'xmlhttprequest'

186 @
´İ”ty


187 
def
 
	`fÜms
(
£lf
):

188  
£lf
.
­¶iÿtiÚ
.
fÜms
[£lf.
loÿË
.
code
]

190 
def
 
	`_
(
£lf
, 
mes§ge
, 
¶u¿l_mes§ge
=
NÚe
, 
couÁ
=None):

191  
£lf
.
loÿË
.
	`Œª¦©e
(
mes§ge
, 
¶u¿l_mes§ge
, 
couÁ
)

194 
şass
 
	`E¼ÜHªdËr
(
Reque¡HªdËr
):

196 
fixed
 
tÜÇdo
.
web
.
Reque¡HªdËr
 
HTTPE¼Ü
 
bug
.

198 
def
 
	`´•¬e
(
£lf
):

199 
£lf
.
	`£t_¡©us
(404)

200 
¿i£
 
tÜÇdo
.
web
.
	`HTTPE¼Ü
(404)

	@pypress/views/blog.py

1 #!/
u¤
/
bš
/
’v
 
pythÚ


2 #codšg=
utf
-8

4 
	gv›ws
: 
blog
.
py


6 :
authÜ
: 
Ïoqiu
.
com
@
gma
.com

8 
impÜt
 
jsÚ


9 
impÜt
 
os


10 
impÜt
 
u¾lib


11 
impÜt
 
loggšg


12 
impÜt
 
tÜÇdo
.
web


13 
impÜt
 
tÜÇdo
.
esÿ³


15 
äom
 
d©‘ime
 
impÜt
 datetime

17 
äom
 
py´ess
.
v›ws
 
impÜt
 
Reque¡HªdËr


18 
äom
 
py´ess
.
d©aba£
 
impÜt
 
db


19 
äom
 
py´ess
.
mod–s
 
impÜt
 
U£r
, 
	gPo¡
, 
	gTag
, 
Comm’t


20 
äom
 
	gpy´ess
.
h–³rs
 
impÜt
 
g’”©e_¿ndom


21 
äom
 
	gpy´ess
.
	guts
.
imag–ib
 
impÜt
 
Reÿ±cha


22 
äom
 
	gpy´ess
.
	gex‹nsiÚs
.
routšg
 
impÜt
 
	grou‹


25 @
rou‹
(
r
'/', 
Çme
='archive')

26 @
rou‹
(
r
'/(\d{4})/', 
Çme
='archive_year')

27 @
rou‹
(
r
'/(\d{4})/(\d{1,2})/', 
Çme
='archive_month')

28 @
rou‹
(
r
'/(\d{4})/(\d{1,2})/(\d{1,2})/', 
Çme
='archive_day')

29 
şass
 
	$Archive
(
Reque¡HªdËr
):

30 
def
 
	$g‘
(
£lf
, 
y—r
=
NÚe
, 
mÚth
=NÚe, 
day
=None):

32 
·ge
 = 
£lf
.
	`g‘_¬gs
('·ge', 1, 
ty³
=)

34 
·ge_obj
 = 
Po¡
.
qu”y
.
	`¬chive
(
y—r
, 
mÚth
, 
day
).
	`as_li¡
() \

35 .
	$·gš©e
(
·ge
õage, 
³r_·ge
=
Po¡
.
PER_PAGE
)

37 
day
:

38 
·th
 = 
£lf
.
	`»v”£_u¾
('¬chive_day', 
y—r
, 
mÚth
, 
day
)

39 
–if
 
mÚth
:

40 
·th
 = 
£lf
.
	`»v”£_u¾
('¬chive_mÚth', 
y—r
, 
mÚth
)

41 
–if
 
y—r
:

42 
·th
 = 
£lf
.
	`»v”£_u¾
('¬chive_y—r', 
y—r
)

44 
·th
 = 
£lf
.
	`»v”£_u¾
('archive')

46 
·ge_u¾
 = 
Ïmbda
 
·ge
: 
·th
 + \

47 '?%s' % 
u¾lib
.
	`u¾’code
(
	$diù
(
·ge
=page))

49 
£lf
.
	`»nd”
("blog/list.html",

50 
·ge_obj
=page_obj,

51 
·ge_u¾
=page_url)

55 @
	`rou‹
(
r
'/¬chives', 
Çme
='archives')

56 
şass
 
	$Archives
(
Reque¡HªdËr
):

57 
def
 
	$g‘
(
£lf
):

59 
·ge
 = 
£lf
.
	`g‘_¬gs
('·ge', 1, 
ty³
=)

61 
·ge_obj
 = 
Po¡
.
qu”y
.
	`as_li¡
() \

62 .
	$·gš©e
(
·ge
õage, 
³r_·ge
=
Po¡
.
PER_PAGE
)

64 
·ge_u¾
 = 
Ïmbda
 
·ge
: 
£lf
.
	`»v”£_u¾
('archives') + \

65 '?%s' % 
u¾lib
.
	`u¾’code
(
	$diù
(
·ge
=page))

67 
£lf
.
	`»nd”
("blog/archives.html",

68 
·ge_obj
=page_obj,

69 
·ge_u¾
=page_url)

73 @
	`rou‹
(
r
'/£¬ch', 
Çme
='search')

74 
şass
 
	$S—rch
(
Reque¡HªdËr
):

75 
def
 
	$g‘
(
£lf
):

77 
keywÜds
 = 
£lf
.
	`g‘_¬gs
('q')

78 
·ge
 = 
£lf
.
	`g‘_¬gs
('·ge', 1, 
ty³
=)

80 
nÙ
 
keywÜds
:

81 
£lf
.
	`»dœeù
('/')

84 
·ge_obj
 = 
Po¡
.
qu”y
.
	`£¬ch
(
keywÜds
).
	`as_li¡
() \

85 .
	$·gš©e
(
·ge
, 
³r_·ge
=
Po¡
.
PER_PAGE
)

87 
·ge_obj
.
tÙ®
 == 1:

88 
po¡
 = 
·ge_obj
.
™ems
[0]

89 
£lf
.
	$»dœeù
(
po¡
.
u¾
)

92 
·ge_u¾
 = 
Ïmbda
 
·ge
: 
£lf
.
	`»v”£_u¾
('search') + \

93 '?%s' % 
u¾lib
.
	`u¾’code
(
	$diù
(
·ge
=page,

94 
q
=
keywÜds
))

96 
£lf
.
	`»nd”
("blog/search.html",

97 
·ge_obj
=page_obj,

98 
·ge_u¾
=page_url,

99 
keywÜds
=keywords)

103 @
	`rou‹
(
r
'/gs', 
Çme
='tags')

104 
şass
 
	$TagW®l
(
Reque¡HªdËr
):

105 
def
 
	$g‘
(
£lf
):

107 
gs
 = 
Tag
.
qu”y
.
	$şoud
()

109 
£lf
.
	`»nd”
("blog/gs.html", 
gs
=tags)

113 @
	`rou‹
(
r
'/g/(.+)', 
Çme
='tag')

114 
şass
 
	$TagV›w
(
Reque¡HªdËr
):

115 
def
 
	$g‘
(
£lf
, 
¦ug
):

117 
·ge
 = 
£lf
.
	`g‘_¬gs
('·ge', 1, 
ty³
=)

119 
g
 = 
Tag
.
qu”y
.
	`f‹r_by
(
¦ug
=¦ug).
	$fœ¡_Ü_404
()

121 
·ge_obj
 = 
g
.
po¡s
.
	`as_li¡
() \

122 .
	$·gš©e
(
·ge
, 
³r_·ge
=
Po¡
.
PER_PAGE
)

124 
·ge_u¾
 = 
Ïmbda
 
·ge
: 
£lf
.
	`»v”£_u¾
('g', 
¦ug
) + \

125 '?%s' % 
u¾lib
.
	`u¾’code
(
	$diù
(
·ge
=page))

127 
£lf
.
	`»nd”
("blog/tag.html",

128 
·ge_obj
=page_obj,

129 
·ge_u¾
=page_url,

130 
gÇme
=
g
.
Çme
)

134 @
	`rou‹
(
r
'/³İË/(.+)', 
Çme
='people')

135 
şass
 
	$PeİË
(
Reque¡HªdËr
):

136 
def
 
	$g‘
(
£lf
, 
u£ºame
):

138 
·ge
 = 
£lf
.
	`g‘_¬gs
('·ge', 1, 
ty³
=)

140 
³İË
 = 
U£r
.
qu”y
.
	$g‘_by_u£ºame
(
u£ºame
)

142 
·ge_obj
 = 
Po¡
.
qu”y
.
	`f‹r
(Po¡.
authÜ_id
==
³İË
.
id
).
	`as_li¡
() \

143 .
	$·gš©e
(
·ge
, 
³r_·ge
=
Po¡
.
PER_PAGE
)

145 
·ge_u¾
 = 
Ïmbda
 
·ge
: 
£lf
.
	`»v”£_u¾
('³İË', 
u£ºame
) + \

146 '?%s' % 
u¾lib
.
	`u¾’code
(
	$diù
(
·ge
=page))

148 
£lf
.
	`»nd”
("blog/people.html",

149 
·ge_obj
=page_obj,

150 
·ge_u¾
=page_url,

151 
³İË
=people)

155 @
	`rou‹
(
r
'/(\d{4})/(\d{1,2})/(\d{1,2})/(.+)', 
Çme
='post_view')

156 
şass
 
	$V›w
(
Reque¡HªdËr
):

157 
def
 
	$g‘
(
£lf
, 
y—r
, 
mÚth
, 
day
, 
¦ug
):

159 
po¡
 = 
Po¡
.
qu”y
.
	$g‘_by_¦ug
(
¦ug
)

161 
d©e
 = (
po¡
.
ü—‹d_d©e
.
y—r
,

162 
po¡
.
ü—‹d_d©e
.
mÚth
,

163 
po¡
.
ü—‹d_d©e
.
day
)

165 ià((
y—r
), (
mÚth
), (
day
)è!ğ
d©e
:

166 
¿i£
 
tÜÇdo
.
web
.
	$HTTPE¼Ü
(404)

168 
£lf
.
	`»nd”
("blog/v›w.html", 
po¡
õo¡, 
fÜm
=£lf.
fÜms
.
	$Comm’tFÜm
())

171 
def
 
	$po¡
(
£lf
, 
y—r
, 
mÚth
, 
day
, 
¦ug
):

174 
po¡
 = 
Po¡
.
qu”y
.
	$g‘_by_¦ug
(
¦ug
)

176 
fÜm
 = 
£lf
.
fÜms
.
	$Comm’tFÜm
(
£lf
.
»que¡
.
¬gum’ts
)

178 
fÜm
.
	$v®id©e
():

180 
ÿ±cha
 = 
fÜm
.ÿ±cha.
d©a


182 
£lf
.
	`g‘_£cu»_cook›
("ÿ±cha"è=ğ
ÿ±cha
:

184 
comm’t
 = 
	$Comm’t
(
po¡
=post,

185 

=
£lf
.
»que¡
.
»mÙe_
)

187 
fÜm
.
	$pİuÏ‹_obj
(
comm’t
)

189 
£lf
.
cu¼’t_u£r
:

190 
comm’t
.
authÜ_id
 = 
£lf
.
cu¼’t_u£r
.
id


192 
db
.
£ssiÚ
.
	$add
(
comm’t
)

193 
db
.
£ssiÚ
.
	$comm™
()

195 
£lf
.
	$»dœeù
(
comm’t
.
u¾
)

198 
fÜm
.
ÿ±cha
.
”rÜs
.
	`­³nd
(
£lf
.
	`_
("Captcha don't match"))

200 
£lf
.
	`»nd”
("blog/v›w.html", 
po¡
õo¡, 
fÜm
=form)

204 @
	`rou‹
(
r
'/po¡', 
Çme
='post')

205 
şass
 
	$Subm™
(
Reque¡HªdËr
):

206 @
tÜÇdo
.
web
.
auth’tiÿ‹d


207 
def
 
	$g‘
(
£lf
):

209 
fÜm
 = 
£lf
.
fÜms
.
	`Po¡FÜm
(
Ãxt
=£lf.
	`g‘_¬gs
('next',''))

211 
£lf
.
	`»nd”
("blog/po¡.html", 
fÜm
=form)

214 @
tÜÇdo
.
web
.
auth’tiÿ‹d


215 
def
 
	$po¡
(
£lf
):

217 
fÜm
 = 
£lf
.
fÜms
.
	$Po¡FÜm
(
£lf
.
»que¡
.
¬gum’ts
)

219 
fÜm
.
	$v®id©e
():

221 
po¡
 = 
	$Po¡
(
authÜ_id
=
£lf
.
cu¼’t_u£r
.
id
)

222 
fÜm
.
	$pİuÏ‹_obj
(
po¡
)

224 
db
.
£ssiÚ
.
	$add
(
po¡
)

225 
db
.
£ssiÚ
.
	$comm™
()

228 
Ãxt_u¾
 = 
fÜm
.
Ãxt
.
d©a


229 
nÙ
 
Ãxt_u¾
:

230 
Ãxt_u¾
 = 
po¡
.
u¾


231 
£lf
.
	$»dœeù
(
Ãxt_u¾
)

234 
£lf
.
	`»nd”
("blog/po¡.html", 
fÜm
=form)

238 @
	`rou‹
(
r
'/po¡/(\d+)/ed™', 
Çme
='post_edit')

239 
şass
 
	$Ed™
(
Reque¡HªdËr
):

240 @
tÜÇdo
.
web
.
auth’tiÿ‹d


241 
def
 
	$g‘
(
£lf
, 
po¡_id
):

243 
po¡
 = 
Po¡
.
qu”y
.
	$g‘_Ü_404
(
po¡_id
)

245 
po¡
.
³rmissiÚs
.
ed™
.
	$‹¡
(
£lf
.
id’t™y
, 401)

247 
fÜm
 = 
£lf
.
fÜms
.
	$Po¡FÜm
(
t™Ë
 = 
po¡
.title,

248 
¦ug
 = 
po¡
.slug,

249 
cÚ‹Á
 = 
po¡
.content,

250 
gs
 = 
po¡
.tags,

251 
obj
 = 
po¡
)

253 
£lf
.
	`»nd”
("blog/ed™.html", 
fÜm
=form)

256 @
tÜÇdo
.
web
.
auth’tiÿ‹d


257 
def
 
	$po¡
(
£lf
, 
po¡_id
):

259 
po¡
 = 
Po¡
.
qu”y
.
	$g‘_Ü_404
(
po¡_id
)

261 
po¡
.
³rmissiÚs
.
ed™
.
	$‹¡
(
£lf
.
id’t™y
, 401)

263 
fÜm
 = 
£lf
.
fÜms
.
	$Po¡FÜm
(
£lf
.
»que¡
.
¬gum’ts
, 
obj
=
po¡
)

265 
fÜm
.
	$v®id©e
():

267 
fÜm
.
	$pİuÏ‹_obj
(
po¡
)

268 
db
.
£ssiÚ
.
	$comm™
()

270 
Ãxt_u¾
 = 
po¡
.
u¾


271 
£lf
.
	$»dœeù
(
Ãxt_u¾
)

274 
£lf
.
	`»nd”
("blog/ed™.html", 
fÜm
=form)

278 @
	`rou‹
(
r
'/po¡/(\d+)/d–‘e', 
Çme
='post_delete')

279 
şass
 
	$D–‘e
(
Reque¡HªdËr
):

280 @
tÜÇdo
.
web
.
auth’tiÿ‹d


281 
def
 
	$g‘
(
£lf
, 
po¡_id
):

283 
po¡
 = 
Po¡
.
qu”y
.
	$g‘_Ü_404
(
po¡_id
)

285 
po¡
.
³rmissiÚs
.
d–‘e
.
	$‹¡
(
£lf
.
id’t™y
, 401)

287 
db
.
£ssiÚ
.
	$d–‘e
(
po¡
)

288 
db
.
£ssiÚ
.
	$comm™
()

290 
£lf
.
	`»dœeù
('/')

294 @
	`rou‹
(
r
'/comm’t/(\d+)/d–‘e', 
Çme
='comment_delete')

295 
şass
 
	$D–‘eComm’t
(
Reque¡HªdËr
):

296 @
tÜÇdo
.
web
.
auth’tiÿ‹d


297 
def
 
	$po¡
(
£lf
, 
comm’t_id
):

299 
comm’t
 = 
Comm’t
.
qu”y
.
	`g‘_Ü_404
((
comm’t_id
))

301 
comm’t
.
³rmissiÚs
.
d–‘e
.
	$‹¡
(
£lf
.
id’t™y
, 401)

303 
db
.
£ssiÚ
.
	$d–‘e
(
comm’t
)

304 
db
.
£ssiÚ
.
	$comm™
()

306 
£lf
.
	`wr™e
(
	$diù
(
sucûss
=
True
,

307 
comm’t_id
=comment_id))

311 @
	`rou‹
(
r
'/u¶ßd', 
Çme
='upload')

312 
şass
 
	$U¶ßd
(
Reque¡HªdËr
):

313 
def
 
	$po¡
(
£lf
):

314 'u¶ßd' 
š
 
£lf
.
»que¡
.
fes
:

315 
f
 = 
£lf
.
»que¡
.
fes
['upload'][0]

317 'image' 
š
 
f
['content_type']:

318 
now
 = 
d©‘ime
.
	$now
()

319 
®t
, 
ext
 = 
os
.
·th
.
	`¥l™ext
(
f
['filename'])

320 
f’ame
 = 
now
.
	`¡ráime
('%d%H%M%S%f'è+ 
ext


321 
dœs
 = 
os
.
·th
.
	`još
(
£lf
.
£‰šgs
['u¶ßd_·th'], 
	`¡r
(
now
.
y—r
), 
	$¡r
(
now
.
mÚth
))

322 
nÙ
 
os
.
·th
.
	$isdœ
(
dœs
):

323 
os
.
	$makedœs
(
dœs
)

324 
·th
 = 
os
.·th.
	$još
(
dœs
, 
f’ame
)

325 
Œy
:

326 
outfe
 = 
	`İ’
(
·th
, 'w')

327 
outfe
.
	`wr™e
(
f
['body'])

328 
outfe
.
	$şo£
()

329 
exû±
:

330 
loggšg
.
	`debug
("uploadƒrror")

331 
”rÜ
 = "save fileƒrror"

333 
f’ame
 = 
os
.
·th
.
	`još
('/u¶ßd', 
	`¡r
(
now
.
y—r
), sŒÒow.
mÚth
), filename)

334 
£lf
.
	`wr™e
(
jsÚ
.
	`dumps
(
	`diù
(
sucûss
=
True
, 
»suÉ
=
	$diù
(
·th
=
f’ame
,
®t
=alt))))

335 #£lf.
	`wr™e
(
	`diù
(
sucûss
=
True
, 
»suÉ
=diù(
·th
=
f’ame
,
®t
=alt)))

338 
”rÜ
 = "file‚ot image"

340 
”rÜ
 = "upload‚ot in„equest.files"

342 
£lf
.
	`wr™e
(
	$diù
(
sucûss
=
F®£
, 
”rÜ
=error))

346 @
	`rou‹
(
r
'/ÿ±cha/g‘', 
Çme
='get_captcha')

347 
şass
 
	$G‘C­tcha
(
Reque¡HªdËr
):

348 
def
 
	$g‘
(
£lf
):

349 
‹xt
 = 
	$g’”©e_¿ndom
(4)

350 
£lf
.
	`£t_£cu»_cook›
("ÿ±cha", 
‹xt
)

352 
¡rIO
 = 
	$Reÿ±cha
(
‹xt
)

354 #,
mim‘y³
='image/png'

355 
£lf
.
	`£t_h—d”
("Content-Type", "image/png")

356 
£lf
.
	`wr™e
(
¡rIO
.
	$»ad
())

360 @
	`rou‹
(
r
'/ÿ±cha/check', 
Çme
='check_captcha')

361 
şass
 
	$CheckC­tcha
(
Reque¡HªdËr
):

362 
def
 
	$g‘
(
£lf
):

364 
ÿ±cha
 = 
£lf
.
	`g‘_¬gs
('captcha')

366 
£lf
.
	`g‘_£cu»_cook›
("ÿ±cha"è=ğ
ÿ±cha
:

367 
sucûss
 = 
True


369 
sucûss
 = 
F®£


371 
£lf
.
	`wr™e
(
	$diù
(
sucûss
=success))

	@pypress/views/links.py

1 #!/
u¤
/
bš
/
’v
 
pythÚ


2 #codšg=
utf
-8

4 
	gv›ws
: 
lšks
.
py


6 :
authÜ
: 
Ïoqiu
.
com
@
gma
.com

8 
impÜt
 
u¾lib


9 
impÜt
 
tÜÇdo
.
web


11 
äom
 
py´ess
.
v›ws
 
impÜt
 
Reque¡HªdËr


12 
äom
 
py´ess
.
d©aba£
 
impÜt
 
db


13 
äom
 
py´ess
.
mod–s
 
impÜt
 
Lšk


14 
äom
 
py´ess
.
ex‹nsiÚs
.
routšg
 
impÜt
 
rou‹


15 
äom
 
py´ess
.
³rmissiÚs
 
impÜt
 
admš


18 @
rou‹
(
r
'/lšks', 
Çme
='links')

19 
şass
 
	$Lšks
(
Reque¡HªdËr
):

20 
def
 
	$g‘
(
£lf
):

22 
·ge
 = 
£lf
.
	`g‘_¬gs
('·ge', 1, 
ty³
=)

24 
·ge_obj
 = 
Lšk
.
qu”y
.
	$·gš©e
(
·ge
õage, 
³r_·ge
=
Lšk
.
PER_PAGE
)

26 
·ge_u¾
 = 
Ïmbda
 
·ge
: 
£lf
.
	`»v”£_u¾
('links') + \

27 '?%s' % 
u¾lib
.
	`u¾’code
(
	$diù
(
·ge
=page))

29 
£lf
.
	`»nd”
("links/list.html",

30 
·ge_obj
=page_obj,

31 
·ge_u¾
=page_url)

35 @
	`rou‹
(
r
'/lšk/add', 
Çme
='link_add')

36 
şass
 
	$Add
(
Reque¡HªdËr
):

37 
def
 
	$g‘
(
£lf
):

39 
fÜm
 = 
£lf
.
fÜms
.
	$LškFÜm
()

41 
£lf
.
	`»nd”
("lšks/add.html", 
fÜm
=form)

44 
def
 
	$po¡
(
£lf
):

46 
fÜm
 = 
£lf
.
fÜms
.
	$LškFÜm
(
£lf
.
»que¡
.
¬gum’ts
)

48 
fÜm
.
	$v®id©e
():

50 
lšk
 = 
	$Lšk
()

51 
fÜm
.
	$pİuÏ‹_obj
(
lšk
)

53 
db
.
£ssiÚ
.
	$add
(
lšk
)

54 
db
.
£ssiÚ
.
	$comm™
()

56 
£lf
.
	`æash
("Waiting for…assed...")

58 
Ãxt_u¾
 = 
£lf
.
	`g‘_¬gs
('Ãxt', s–f.
	`»v”£_u¾
('links'))

59 
£lf
.
	$»dœeù
(
Ãxt_u¾
)

61 
£lf
.
	`»nd”
("lšks/add.html", 
fÜm
=form)

65 @
	`rou‹
(
r
'/lšk/(\d+)/·ss', 
Çme
='link_pass')

66 
şass
 
	$Pass
(
Reque¡HªdËr
):

67 @
tÜÇdo
.
web
.
auth’tiÿ‹d


68 @
admš
.
	$»quœe
(401)

69 
def
 
	$g‘
(
£lf
, 
id
):

71 
lšk
 = 
Lšk
.
qu”y
.
	`g‘_Ü_404
((
id
))

73 
lšk
.
·s£d
 = 
True


75 
Ãxt_u¾
 = 
£lf
.
	`g‘_¬gs
('Ãxt', s–f.
	`»v”£_u¾
('links'))

76 
£lf
.
	$»dœeù
(
Ãxt_u¾
)

80 @
	`rou‹
(
r
'/lšk/(\d+)/d–‘e', 
Çme
='link_delete')

81 
şass
 
	$D–‘e
(
Reque¡HªdËr
):

82 @
tÜÇdo
.
web
.
auth’tiÿ‹d


83 @
admš
.
	$»quœe
(401)

84 
def
 
	$g‘
(
£lf
, 
id
):

86 
lšk
 = 
Lšk
.
qu”y
.
	`g‘_Ü_404
((
id
))

88 
db
.
£ssiÚ
.
	$d–‘e
(
lšk
)

89 
db
.
£ssiÚ
.
	$comm™
()

91 
Ãxt_u¾
 = 
£lf
.
	`g‘_¬gs
('Ãxt', s–f.
	`»v”£_u¾
('links'))

92 
£lf
.
	$»dœeù
(
Ãxt_u¾
)

	@
1
.
0
30
732
manager.py
pypress/__init__.py
pypress/database.py
pypress/extensions/__init__.py
pypress/extensions/cache.py
pypress/extensions/forms.py
pypress/extensions/permission.py
pypress/extensions/routing.py
pypress/extensions/sessions.py
pypress/extensions/signals.py
pypress/extensions/sqlalchemy.py
pypress/filters.py
pypress/forms.py
pypress/helpers.py
pypress/local_settings.py
pypress/models/__init__.py
pypress/models/blog.py
pypress/models/links.py
pypress/models/types.py
pypress/models/users.py
pypress/permissions.py
pypress/settings.py
pypress/uimodules.py
pypress/utils/__init__.py
pypress/utils/imagelib.py
pypress/views/__init__.py
pypress/views/account.py
pypress/views/base.py
pypress/views/blog.py
pypress/views/links.py
